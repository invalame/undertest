<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- ANTI-CACHE: Forzar al navegador a siempre buscar la versión más nueva -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta http-equiv="Permissions-Policy"
        content="autoplay=*, encrypted-media=*, accelerometer=*, gyroscope=*, picture-in-picture=*, clipboard-write=*, web-share=*">
    <title>UnderLess</title>
    <meta name="description" content="en UnderLess tenés que adivinar artistas y canciones del under argentino.">
    <meta property="og:title" content="UnderLess">
    <meta name="application-name" content="UnderLess">
    <link rel="icon" href="underless.ico">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <!-- UnderLess Sidebar Styles (scoped) -->
    <link rel="stylesheet" href="underless-sidebar.css">
    <style>
        @font-face {
            font-family: 'UnderLessFont';
            src: url('fonts/UnderLess_font.ttf') format('truetype');
            font-weight: 800;
            font-style: normal;
        }

        @font-face {
            font-family: 'OtherTextFont';
            src: url('fonts/other_text.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'ChillFont';
            src: url('fonts/chill_font.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'PoppinsFont';
            src: url('fonts/Poppins-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'PoppinsFont';
            src: url('fonts/Poppins-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }



        :root {
            --bg: #161819;
            --panel: #242829;
            --muted: #b3b3b3;
            --accent: #55b725;
            --bar-bg: #27282a;
            --white: #ffffff;
            --bar-active: #ffffff;
            --grisesito: #575757;
            --artist_header: #91ff00c5;

            --modal-win: var(--accent);
            --modal-lose: #b42828;
            --modal-title-win: #ffffff;
            --modal-title-lose: #ffffff;
            --modal-bg-header: #962020;
            --modal-bg-body: #212425;

            /* COLOR PARA SKIP (GRIS OSCURO) */
            --skip-color: #313536;

            /* COLORES PARA RACHA */
            --streak-zero: var(--muted);
            --streak-low: #ec9a00;
            --streak-medium: #ff6600;
            --streak-high: #ff0000;

        }

        /* GLOBAL SCROLLBAR (Internal elements default to Green) */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--accent);
            border-radius: 5px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: #4a9e20;
        }

        /* CUSTOM SCROLLBAR BODY ONLY (Overrides global to Gray) */
        html::-webkit-scrollbar,
        body::-webkit-scrollbar {
            width: 10px !important;
            height: 10px !important;
        }

        html::-webkit-scrollbar-track,
        body::-webkit-scrollbar-track {
            background: transparent !important;
        }

        html::-webkit-scrollbar-thumb,
        body::-webkit-scrollbar-thumb {
            background-color: var(--grisesito) !important;
            border-radius: 5px !important;
            border: 2px solid transparent !important;
            background-clip: content-box !important;
        }

        html::-webkit-scrollbar-thumb:hover,
        body::-webkit-scrollbar-thumb:hover {
            background-color: #777 !important;
        }

        /* STANDARD SCROLLBAR SUPPORT (FireFox, etc) */
        html,
        body {
            scrollbar-color: var(--grisesito) transparent !important;
            scrollbar-width: thin !important;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            overflow-x: hidden;
        }

        body {
            background-color: var(--bg);
            color: var(--white);
            font-family: 'OtherTextFont', sans-serif;
            /* Fuente local para todo el body */
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            justify-content: flex-start;




        }





        #ui-root {
            width: 100%;
            /* changed from fixed 900px to use full width */
            max-width: 1400px;
            /* set a reasonable max-width for very large screens */
            height: 950px;
            /* altura base */
            transform-origin: top center;
        }

        @media (min-width: 1024px) {
            #ui-root {
                width: 1200px;
            }
        }


        /* HEADER PARA CENTRAR EL LOGO Y EL EMOTE VERTICALMENTE */
        header {
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 25px 10px 10px 25px;
            box-sizing: border-box;
            max-width: 900px;
            position: relative;
            z-index: 50;
        }

        header .logo {
            font-family: 'UnderLessFont', sans-serif;
            /* Fuente local para el logo */
            font-size: 3.8em;
            font-weight: 800;
            letter-spacing: -1px;
            cursor: default;
            text-transform: none;
            /* No uppercase para permitir U mayÃÂºscula y resto minÃÂºscula */
            --colorunder: #0082c4;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;

        }

        /* ESTILO PARA EL EMOTE */
        #emote-7tv {
            width: 170px;
            height: 50px;
            margin-top: 3px;
            display: block;
        }

        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 900px;
            padding: 0 20px 50px 20px;
            box-sizing: border-box;
            position: relative;
        }

        @media (min-width: 1024px) {

            header,
            main,
            .progress-wrapper,
            .search-controls-container {
                max-width: 100%;
                /* Let containers fill the parent ui-root */
            }
        }


        .guess-boxes {
            width: 100%;
            margin-bottom: 30px;
            max-width: 650px;
            /* Narrower than previous 900px, but wider than original 550px? 
               User said "mas angostas" (narrower) and "mas ancha" (wider) for progress. 
               Let's go 650px for guess boxes. */
        }

        .guess-box {

            background-color: var(--bg);
            /* fondo igual al body */
            border: 2px solid var(--panel);
            /* borde del color de acento */
            border-radius: 4px;
            border-radius: 6px;
            /* un poquito de borde redondo, no exagerado (previously 4px) */
            padding: 16px 18px;
            /* Increased vertical padding (was 13px) for "un pelin mas altas" */
            margin-bottom: 8px;
            color: var(--muted);
            height: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1.2em;
            font-weight: 500;
            transition: background-color 0.2s, border-color 0.2s;
            /* transiciÃÂ³n para el cambio de color */
        }

        /* ESTADO POR DEFECTO: CASILLA VACÃÂA */
        .guess-box:empty {
            background-color: var(--bg);
            border: 2px solid var(--panel);
        }

        /* ESTADO: CASILLA LLENA (ANTES DE SER JUZGADA) */
        .guess-box:not(:empty):not(.correct):not(.incorrect):not(.skipped):not(.partial) {
            background-color: var(--panel);
            /* color de panel por si hay texto temporal */
            border-color: var(--panel);
        }

        /* ANIMACIÃâN POP GLOBAL */
        @keyframes popIn {
            0% {
                transform: scale(0.9);
                opacity: 0;
            }

            70% {
                transform: scale(1.05);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .guess-box.skipped,
        .guess-box.incorrect,
        .guess-box.correct,
        .guess-box.partial {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            /* Pop effect */
            /* border: none; REMOVED to prevent layout jump (keeps 2px border from base class) */
        }

        .guess-box.correct {
            background-color: var(--accent);
            /* Verde */
            color: white;
            animation: none;
            border-color: var(--accent);
            /* relleno completo */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        * {
            /* Scrollbar styles */
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--panel);
        }

        /* CUSTOM SELECTION COLOR (Grisesito) */
        ::selection {
            background-color: #41414177;
            /* Gris */
            color: #ffffff;
        }

        .guess-box.incorrect {
            background-color: #ff3333;
            /* Rojo */
            border-color: #cc0000;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .guess-box.partial {
            background-color: #ca9400;
            /* Amarillo */
            border-color: #e6c200;
            color: #ffffff;
            /* Texto negro para contraste */
        }

        /* ESTADO PARA SKIP */
        .guess-box.skipped {
            background-color: var(--skip-color);
            /* Gris oscuro */
            color: white;
            border-color: var(--skip-color);
            /* relleno completo */
        }



        /* Barra de Progreso */
        /* Barra de Progreso */
        .progress-wrapper {
            position: relative;
            width: 100%;
            max-width: 1050px;
            /* Slightly narrower as requested (1050px vs 1100px) */
            margin-bottom: 25px;
            /* Reducido para subir el botÃÂ³n Play */
            margin-top: 50px;
            /* Bajalo un poco nomÃ¡s */
        }

        .progress-bar-container {
            width: 100%;
            height: 25px;
            background-color: var(--bar-bg);
            border-radius: 4px;
            /* Sutil */
            position: relative;
            overflow: hidden;
            /* Recorta los bordes rectos del hijo */
        }

        .progress-bar-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: var(--bar-active);
            width: 0%;
            border-radius: 0;
            /* Recto, el padre recorta */
            z-index: 1;
        }

        .segments-overlay {
            position: relative;
            display: flex;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        .progress-segment {
            position: relative;
            height: 100%;
        }

        .progress-segment:last-child {
            border-right: none;
        }

        .segment-divider {
            position: absolute;
            top: 0;
            height: 100%;
            width: 1px;
            background-color: var(--bg);
            z-index: 3;
            transform: translateX(-50%);
        }

        /* Marcador de tiempo (flecha estÃ¡tica) */
        .timer-text {
            position: absolute;
            top: -35px;
            left: 0%;
            transform: translateX(-50%);
            font-size: 0.9em;
            color: var(--white);
            white-space: nowrap;
            font-weight: bold;
            transition: none;
            z-index: 10;
        }

        .timer-text::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -8px;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 6px solid var(--white);
        }

        /* Boton de Play/Pause */
        button.play-button {
            background-color: var(--accent);
            border-radius: 50%;
            width: 65px;
            /* Un pelin mÃ¡s grande (antes 60) */
            height: 65px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.4);
            position: relative;
            margin-top: 5px;
            /* MÃ¡s arriba */
            margin-bottom: 15px;
            /* Espacio para la racha */
            opacity: 1;
            border: none;
        }

        button.play-button[disabled] {
            opacity: 0.5;
            cursor: default;
        }

        button.play-button:not([disabled]):active {
            /* REMOVED ANIMATION */
            transform: none;
        }

        button.play-button svg {
            fill: white;
            width: 32px;
            /* Ajustado proporcionalmente */
            height: 32px;
            margin-left: 3px;
        }

        /* Controles de Busqueda */
        .search-controls-container {
            width: 100%;
            max-width: 900px;
            margin-top: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .controls-row {
            display: flex;
            align-items: center;
            width: 100%;
            justify-content: center;
            gap: 10px;
        }

        .search-container {
            display: flex;
            flex-grow: 1;
            max-width: 600px;
            /* Keep search bar somewhat compact as requested */
            background-color: var(--panel);
            border-radius: 4px;
            opacity: 1;
            transition: opacity 0.3s;
            /* overflow: hidden; REMOVED to allow songs-list to show outside/above */
            position: relative;
            /* Ensure absolute child positions are relative to this */
            align-items: center;
            /* Ensure icon is centered vertically */
        }

        .search-container.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .search-container svg {
            fill: var(--muted);
            margin-left: 12px;
            width: 18px;
            height: 18px;
        }

        .search-input {
            flex-grow: 1;
            padding: 12px 15px;
            /* REDUCIDO: de 18px a 12px */
            background: transparent;
            border: none;
            color: white;
            font-size: 1.0em;
            /* REDUCIDO: de 1.1em a 1.0em */
            outline: none;
        }

        .centered-text {
            text-align: center;
            font-family: 'PoppinsFont', sans-serif !important;
            font-weight: bold;
            padding-right: 30px;
            /* Balance icon width to visually center */
        }


        .search-input::placeholder {
            color: var(--muted)
        }

        /* Botón Skip */
        #skip-button-standalone {
            background-color: var(--white);
            color: var(--panel);
            border: none;
            padding: 12px 10px;
            font-size: 1.0em;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
            font-weight: bold !important;
            font-family: 'PoppinsFont', sans-serif !important;

            min-width: 110px;
            text-align: center;
            user-select: none;
            -webkit-user-select: none;
        }


        #skip-button-standalone:hover:not(:disabled) {
            background-color: #e0e0e0;
        }

        #skip-button-standalone:disabled {
            cursor: default;
            opacity: 0.5;
        }

        /* Modo "Mandale" (Submit) */
        #skip-button-standalone.submit-mode {
            background-color: var(--accent);
            /* Verde */
            color: white;
        }

        #skip-button-standalone.submit-mode:hover {
            background-color: #4a9e20;
            /* Verde mÃ¡s oscuro */
        }

        #audio-player {
            display: none
        }

        /* Lista de Sugerencias */
        #songs-list {
            position: absolute;
            background-color: var(--panel);
            border-radius: 4px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
            width: 100%;
            /* Ancho exacto del contenedor padre */
            max-width: none;
            /* Quitar max-width heredado */
            top: auto;
            bottom: 100%;
            /* Pegado al borde superior del input */
            margin-bottom: 5px;
            /* PequeÃÂ±o espacio */
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            transform-origin: bottom;
        }

        #songs-list.show {
            display: block;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            color: #ffffff;
            font-size: 1em;
            text-align: left
        }

        .suggestion-item:hover {
            background-color: #333333
        }

        .suggestion-item {
            font-family: 'ChillFont', sans-serif;
        }

        #game-over-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            pointer-events: none;
            background-color: rgba(0, 0, 0, 0.6);
        }

        #game-over-message.show {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .game-over-content {
            background-color: var(--modal-bg-body);
            padding: 0;
            border-radius: 10px;
            overflow: hidden;
            /* Esto asegura que el header respete los bordes redondeados */
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            width: 400px;
            display: flex;
            flex-direction: column;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #game-over-message.show .game-over-content {
            transform: scale(1);
        }

        .game-over-header {
            padding: 20px 30px;
            /* Padding del header */
            background-color: var(--modal-bg-header);
            /* Fondo rojo/verde del header */
            color: var(--white);
            text-align: center;
        }

        .game-over-body {
            padding: 30px;
            /* Padding del cuerpo principal */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        /* Estilos de tÃÂ­tulo */
        #game-result {
            font-size: 2.2em;
            font-weight: 600;
            text-transform: uppercase;
            margin: 0;
        }

        /* Color dinÃ¡mico para el header */
        .game-over-content.win .game-over-header {
            background-color: var(--modal-win);
            /* Verde */
            color: var(--modal-title-win);
        }

        .game-over-content.win {
            border: 2px solid var(--modal-win);
        }

        .game-over-content.lose .game-over-header {
            background-color: var(--modal-lose);
            /* Rojo */
            color: var(--modal-title-lose);
        }

        .game-over-content.lose {
            border: 2px solid var(--modal-lose);
        }

        /* Estilo de la respuesta */
        #correct-answer-container {
            font-size: 1.1em;
            color: var(--white);
            /* Texto principal blanco */
            margin: 0;
            text-align: center;
        }

        #correct-answer-container .label {
            font-size: 0.8em;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 5px;
            display: block;
        }

        #correct-answer {
            font-size: 1.1em;
            font-weight: bold;
            display: block;
        }


        /* Botones del pop-up */
        .action-button {
            border: none;
            padding: 12px 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 0px;
            /* Para icon + text */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .play-again-button {
            background-color: var(--accent);
            color: white;
            margin-top: 10px;
        }

        .play-again-button:hover {
            background-color: #4a9e20;
        }

        /* Ajuste de hover para contraste en estado WIN (verde) */


        /* ESTILOS PARA REPRODUCTOR COMPLETO */
        .full-player-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px 0 5px 0;
            border-top: 1px solid #444;
            /* Separador visual mÃ¡s claro */
            margin-top: 10px;
        }

        /* Centrar botÃÂ³n y apilar tiempo debajo */
        .full-player-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            /* Espacio entre el botÃÂ³n y el tiempo */
        }

        .mini-play-button {
            width: 35px;
            height: 35px;
            min-width: 35px;
            min-height: 35px;
            padding: 0;
            border-radius: 50%;
            background-color: var(--grisesito);
            box-shadow: none;
            border: none;
            cursor: pointer;
        }

        .mini-play-button svg {
            width: 18px;
            height: 18px;
            fill: white;
            margin-left: 2px;
        }

        .mini-play-button:active {
            transform: scale(0.95);
        }


        /* Slider de BÃÂºsqueda (Seeker) */
        #full-song-seeker {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: var(--bar-bg);
            border-radius: 999px;
            outline: none;
            cursor: pointer;
        }

        #full-song-seeker::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--grisesito);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
            cursor: pointer;
        }

        #full-song-seeker::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--grisesito);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
            cursor: pointer;
        }


        /* recommend button style */
        .recommend-btn {
            position: fixed;
            top: 15px;
            right: 145px;
            background: var(--panel);
            color: var(--muted);
            border: none;
            padding: 8px 14px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            z-index: 100;
            font-family: 'PoppinsFont', sans-serif;
        }

        .recommend-btn:hover {
            color: var(--white);
        }

        /* bugs button style */
        .bugs-btn {
            position: fixed;
            top: 15px;
            right: 75px;
            background: var(--panel);
            color: var(--muted);
            border: none;
            padding: 8px 14px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            z-index: 100;
            font-family: 'PoppinsFont', sans-serif;
        }

        .bugs-btn:hover {
            color: var(--white);
        }


        /* bugs modal */
        #bugs-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            /* Flex siempre para centrar, controlamos visibilidad */
            justify-content: center;
            align-items: center;
            z-index: 7000;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #bugs-modal.show {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        #bugs-modal .modal-box {
            background-color: var(--panel);
            border: 1px solid var(--grisesito);
            border-radius: 12px;
            padding: 30px 35px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            font-family: 'PoppinsFont', sans-serif;
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #bugs-modal.show .modal-box {
            transform: scale(1);
        }

        #bugs-modal .close-x {
            position: absolute;
            top: 12px;
            right: 15px;
            background: none;
            border: none;
            color: var(--muted);
            font-size: 1.4em;
            cursor: pointer;
            line-height: 1;
            padding: 0;
        }

        #bugs-modal .close-x:hover {
            color: var(--white);
        }

        #bugs-modal h3 {
            margin: 0 0 20px 0;
            color: var(--white);
            font-size: 1.2em;
        }

        #bugs-modal p {
            color: var(--muted);
            font-size: 0.9em;
            margin: 0 0 18px 0;
            line-height: 1.5;
        }

        #bugs-modal kbd {
            background: var(--bg);
            padding: 4px 10px;
            border-radius: 4px;
            font-family: monospace;
            color: var(--white);
            font-size: 0.85em;
        }

        #bugs-modal .twitter-link {
            display: inline-block;
            background: var(--bg);
            color: var(--muted);
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.85em;
            margin-top: 5px;
        }

        #bugs-modal .twitter-link:hover {
            color: var(--white);
        }

        /* recommend modal - reuses same styles as bugs modal */
        #recommend-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 7000;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #recommend-modal.show {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        #recommend-modal .modal-box {
            background-color: var(--panel);
            border: 1px solid var(--grisesito);
            border-radius: 12px;
            padding: 30px 35px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            font-family: 'PoppinsFont', sans-serif;
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #recommend-modal.show .modal-box {
            transform: scale(1);
        }

        #recommend-modal .close-x {
            position: absolute;
            top: 12px;
            right: 15px;
            background: none;
            border: none;
            color: var(--muted);
            font-size: 1.4em;
            cursor: pointer;
            line-height: 1;
            padding: 0;
        }

        #recommend-modal .close-x:hover {
            color: var(--white);
        }

        #recommend-modal h3 {
            margin: 0 0 20px 0;
            color: var(--white);
            font-size: 1.2em;
        }

        #recommend-modal p {
            color: var(--muted);
            font-size: 0.9em;
            margin: 0 0 18px 0;
            line-height: 1.5;
        }

        #recommend-modal .twitter-link {
            display: inline-block;
            background: var(--bg);
            color: var(--muted);
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.85em;
            margin-top: 5px;
        }

        #recommend-modal .twitter-link:hover {
            color: var(--white);
        }

        .reset-button {
            position: absolute;
            top: 25px;
            left: 30px;
            background: linear-gradient(135deg, #424242 0%, #3b3b3b 100%);
            color: var(--white);
            border: none;
            padding: 8px 16px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }

        .reset-button:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #424242 0%, #3b3b3b 100%);
        }

        .reset-button:active {
            transform: translateY(0);
        }


        .game-over-content.lose .play-again-button {
            background-color: var(--modal-lose);
            /* Utiliza el rojo de perder */
        }

        .game-over-content.lose .play-again-button:hover {
            background-color: #570600;
            /* Rojo mÃ¡s oscuro para hover/interacciÃÂ³n */
        }


        /* responsive */
        @media (max-width:850px) {
            body {
                zoom: 1;
                overflow-y: auto;
            }

            .guess-boxes {
                max-width: 90%;
            }

            .progress-bar-container {
                max-width: 100%;
            }

            .search-controls-container {
                max-width: 90%;
            }

            .search-container {
                max-width: calc(90% - 70px);
            }

            #songs-list {
                max-width: calc(90% - 70px);
            }

            .volume-container {
                display: none;
            }

            .reset-button {
                left: 10px;
            }

            header {
                padding-right: 10px;
                padding-left: 10px;
            }

            .game-over-content {
                padding: 0;
            }

            /* Eliminado padding */

        }

        /* === MOBILE PHONE SPECIFIC === */
        @media (max-width: 480px) {
            body {
                overflow-x: hidden;
                overflow-y: auto;
                height: auto;
                min-height: 100vh;
                min-height: 100dvh;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                padding-top: 10px;
            }

            #ui-root {
                width: 100%;
                height: auto;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            header {
                padding: 5px 15px;
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            header .logo {
                font-size: 2.8em;
                margin-bottom: 3px;
            }

            #emote-7tv {
                width: 130px;
                height: auto;
                margin-top: 0;
            }

            .mode-selector {
                margin-top: 10px;
                margin-bottom: 5px;
                padding: 4px;
                gap: 6px;
            }

            .mode-button {
                padding: 8px 16px;
                font-size: 0.95em;
            }

            main {
                margin-top: 15px;
                /* More spacing from header */
                padding: 0 15px 25px 15px;
                /* More horizontal padding */
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            /* Artist section - CENTERED */
            #artist-section {
                margin-bottom: 18px;
                /* More space below */
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                /* Force center */
            }

            .artist-search-container {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                /* Center the search container */
            }

            .artist-search-container .search-container {
                width: 100%;
                /* Full width */
                max-width: 100%;
            }

            #current-artist-display {
                font-size: 1.1em;
                margin-bottom: 10px;
                text-align: center;
                width: 100%;
            }

            /* Guess boxes */
            .guess-boxes {
                margin-bottom: 18px;
                /* More space */
                width: 100%;
                max-width: 100%;
            }

            .guess-box {
                padding: 12px 14px;
                margin-bottom: 6px;
                height: auto;
                min-height: 20px;
                font-size: 1em;
            }

            /* Progress bar */
            .progress-bar-container {
                width: 100% !important;
                /* Force full width */
                height: 22px;
                margin-bottom: 15px;
            }

            .timer-text {
                font-size: 0.85em;
                top: -26px;
            }

            /* Racha */
            #streak {
                font-size: 1.15em;
                margin-top: 8px;
                margin-bottom: 10px;
                /* More space */
            }

            /* Play button */
            button.play-button {
                width: 60px;
                /* Bigger */
                height: 60px;
                margin-top: 10px;
                margin-bottom: 25px;
                /* More space below */
            }

            button.play-button svg {
                width: 26px;
                height: 26px;
            }

            /* Search controls - LARGER */
            .search-controls-container {
                width: 100%;
                gap: 8px;
                margin-top: 5px;
            }

            .controls-row {
                width: 100%;
                display: flex;
                gap: 8px;
                align-items: center;
                justify-content: center;
                /* Center the row */
            }

            .search-container {
                flex: 1;
                min-width: 0;
                height: 55px;
                /* Bigger search bar */
            }

            .search-input {
                padding: 12px 16px;
                font-size: 1.05em;
                height: 100%;
                box-sizing: border-box;
                width: 100%;
            }

            #skip-button-standalone {
                padding: 0 20px;
                font-size: 1.05em;
                height: 55px;
                /* Match search bar */
                white-space: nowrap;
                flex-shrink: 0;
            }

            #songs-list {
                width: 100%;
                max-width: none;
                max-height: 200px;
            }

            .suggestion-item {
                padding: 12px 16px;
                font-size: 1em;
            }

            /* Streaks & Lives UI */
            #streak-saver-ui {
                font-size: 0.95em;
                padding: 8px 12px;
                margin-top: 15px;
                /* More space */
            }

            #streak-saver-ui img {
                width: 18px;
                height: 18px;
            }

            /* Reset button */
            .reset-button {
                top: 8px;
                left: 8px;
                padding: 6px 12px;
                font-size: 0.8em;
            }

            /* Game Over Modal */
            .game-over-content {
                width: 92%;
                max-width: 400px;
            }

            .game-over-header {
                padding: 15px 20px;
            }

            #game-result {
                font-size: 1.8em;
            }

            .game-over-body {
                padding: 20px;
                gap: 15px;
            }

            .action-button {
                padding: 14px 24px;
                font-size: 1.05em;
            }
        }

        /* Extra small phones */
        @media (max-width: 380px) {
            header .logo {
                font-size: 2.4em;
            }

            #emote-7tv {
                width: 110px;
                height: 32px;
            }

            .guess-box {
                padding: 8px 12px;
                margin-bottom: 4px;
                height: 10px;
                font-size: 0.9em;
            }

            .progress-bar-container {
                height: 18px;
            }

            button.play-button {
                width: 45px;
                height: 45px;
            }

            #streak {
                font-size: 1em;
            }
        }

        /* ESTILO PARA RACHA */
        #streak {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 5px;
            margin-bottom: 25px;
            /* Espacio antes del buscador */
            color: var(--accent);
            user-select: none;
            pointer-events: none;
        }

        /* SISTEMA DE COLORES PARA RACHA (reemplaza el anterior) */
        :root {
            /* Racha 1-10: de verde a rojo */
            --streak-1: #55b725;
            /* verde original */
            --streak-5: #ffd000;
            --streak-10: #ff3300;
            /* rojo fuerte */

            /* Racha 11-20: rojo cada vez mÃ¡s oscuro/intenso */
            --streak-15: #cc0000;
            --streak-20: #990000;

            /* Racha 21-25: violeta suave Ã¢â â violeta medio */
            --streak-21: #b14aed;
            --streak-25: #9c3be0;

            /* Racha 26+: violeta intenso */
            --streak-max: #8a2be2;

            /* Racha 170+: celeste piola */
            --streak-cyan: #00d4ff;
        }

        #streak {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 10px;
            color: var(--streak-1);
            /* color por defecto */
            transition: color 0.5s ease;
            /* animaciÃÂ³n suave al cambiar racha */
        }

        /* Estilo para etiqueta de creador */
        #creator-tag {
            font-size: 0.8em;
            color: var(--muted);
            text-align: center;
            margin: 0;
            padding: 0;
        }

        /* Estilo para streak-saver-ui */
        #streak-saver-ui {
            position: relative;
            /* No fixed */
            margin-top: 5px;
            /* Space from search input */
            margin-bottom: 0px;
            /* Reduced space to avoid scroll */

            font-size: 1.0em;
            color: var(--white);
            text-align: center;
            padding: 8px 15px;
            background-color: var(--panel);
            border-radius: 8px;
            /* Nice rounded corners again */
            box-shadow: none;
            /* Sin sombra */

            width: fit-content;
            margin-left: auto;
            margin-right: auto;

            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            z-index: 10;
        }

        #streak-saver-ui img {
            width: 20px;
            height: 20px;
            /* Forzar altura igual al ancho */
            object-fit: contain;
            margin-left: 0;
            /* Quitar margen extra si usamos gap */
            vertical-align: middle;
        }

        .mode-artist-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: transparent;
            padding: 0;
            margin-top: 15px;
            gap: 0;
            width: fit-content;
            position: relative;
            /* Context needed for absolute positioning if we wanted, but we use fixed for art */
        }

        /* === CONTENEDOR UNIFICADO MODO + ARTISTA === */
        .mode-artist-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: transparent;
            padding: 0;
            margin-top: 15px;
            gap: 0;
            width: fit-content;
        }

        /* === ESTILOS PARA EL SELECTOR DE MODO === */
        .mode-selector {
            display: flex;
            background-color: #202020;
            /* Dark container like visual reference */
            padding: 4px;
            border-radius: 8px;
            position: relative;
            gap: 2px;
        }

        /* Remove the old layered background approach */
        .mode-selector::before {
            display: none;
        }

        .mode-button {
            background: transparent;
            border: none;
            color: #666;
            /* Muted text */
            padding: 6px 20px;
            cursor: pointer;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.2s;
            font-family: 'PoppinsFont', sans-serif;
            /* Clean font */
            font-size: 0.9em;
            position: relative;
            z-index: 2;
        }

        .mode-button:hover:not(.active) {
            color: #aaa;
        }

        .mode-button.active {
            background: #55b725;
            /* Lighter dark grey */
            color: #ffffff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }



        /* === ESTILOS PARA LA SECCIÃâN DE ARTISTA === */
        #artist-section {
            width: 100%;
            max-width: 300px;
            /* REDUCIDO: mÃ¡s angosto */
            margin-bottom: 20px;
            display: none;
            /* Oculto por defecto */
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #artist-section.show {
            display: flex;
        }

        .artist-search-container {
            width: 100%;
            position: relative;
        }

        #current-artist-display {
            display: none;
        }

        #artist-list {
            position: absolute;
            background-color: var(--panel);
            border-radius: 4px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
            width: 100%;
            top: 100%;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        #artist-list.show {
            display: block;
        }

        /* === ESTILOS PARA LA SECCIÃâN DE ÃÂLBUM === */
        #album-section {
            width: 100%;
            max-width: 300px;
            margin-bottom: 20px;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #album-section.show {
            display: flex;
        }

        #album-list {
            position: absolute;
            background-color: var(--panel);
            border-radius: 4px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
            width: 100%;
            top: 100%;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        /* Ensure main is relative so absolute children anchor to it */
        main {
            position: relative !important;
        }

        #album-list.show {
            display: block;
        }

        /* Wrapper to strictly contain the game board width */
        /* Wrapper to strictly contain the game board width */
        .game-board-wrapper {
            width: 100%;
            max-width: 1050px;
            margin: 0 auto;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ALBUM ART DISPLAY CONTAINER 
           Positioned ABSOLUTE relative to the .game-board-wrapper
        */
        #album-art-container {
            position: absolute;
            /* Anchored to the right edge of the 1050px wrapper */
            right: -120px;
            /* Moved right as requested (was -40px) */
            /* User confirmed horizontal is good */
            top: 0px;
            /* Aligned with top of wrapper (guess boxes) */

            display: none !important;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 5px;

            z-index: 100;
            background-color: var(--panel);
            padding: 15px;
            border-radius: 12px;
            width: 170px;
            height: auto;
            box-shadow: none;
            /* Removed shadow */
            border: 1px solid #444;
        }

        #album-art-display {
            box-shadow: none !important;
            border-radius: 4px;
            /* Optional: keep it nice */
        }

        /* WARNING NOTIFICATION (Duplicate Song) */
        #streak-warning {
            position: fixed;
            top: 20px;
            left: 50%;
            /* User requested "un poquitito mas a la izquierda" */
            transform: translateX(-48%);

            background-color: #2a2a2a;
            /* standard dark gray */
            color: white;
            border: 2px solid #ff9100;
            /* Orange stroke */

            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'PoppinsFont', sans-serif;
            font-weight: bold;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            /* Added visibility delay to allow opacity fade out */
            transition: opacity 0.5s ease, transform 0.5s ease, visibility 0s 0.5s;
            pointer-events: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        #streak-warning.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-48%) translateY(10px);
            /* Reset visibility delay when showing so it appears instantly */
            transition: opacity 0.5s ease, transform 0.5s ease, visibility 0s 0s;
        }

        #album-art-container.show {
            display: flex !important;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Hide on mobile/tablets (<1100px) */
        @media (max-width: 1100px) {

            #album-art-container,
            #album-art-container.show {
                display: none !important;
            }
        }

        #album-label {
            color: #bbb;
            font-size: 10px;
            font-weight: bold;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            text-align: center;
            width: 100%;
            margin-bottom: 2px;
            /* Force static positioning to prevent drift */
            position: static !important;
            transform: none !important;
        }

        #album-art-display {
            width: 150px;
            height: 150px;
            border-radius: 8px;
            border: 2px solid #444;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
            flex-shrink: 0;
            /* Force static positioning to prevent drift */
            position: static !important;
            transform: none !important;
            margin: 0 !important;
            /* Let flex gap handle spacing */
        }

        #album-name-display {
            color: white;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            max-width: 160px;
            word-wrap: break-word;
            line-height: 1.3;
            /* Force static positioning to prevent drift */
            position: static !important;
            transform: none !important;
        }

        /* End of Album Art styles */
        /* ALBUM LIST ITEM WITH IMAGE */
        .album-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .album-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .album-item-text {
            flex: 1;
            padding-right: 10px;
        }

        .album-item-image {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            object-fit: cover;
            flex-shrink: 0;
        }

        /* Make parent relative so absolute positioning works relative to the main container logic? 
           Actually, putting it inside .mode-artist-container might be too small context.
           Let's put it in main or header? 
           Better: Fix it to the screen if there is space, or put it in flow on mobile.
        */

        @media (min-width: 1400px) {
            #album-art-display {
                right: calc(50% - 700px);
                /* Align with the new wider container edge? No */
                /* Let's try fixed positioning relative to the centered column */
                position: fixed;
                right: 50px;
                top: 150px;
            }
        }

        /* On smaller screens, maybe hide it or show it smaller? */
        @media (max-width: 1100px) {
            #album-art-display {
                display: none !important;
                /* Hide on small screens for now to avoid overlap */
            }
        }

        /* TIPOGRAFÃÂA POPPINS PARA ELEMENTOS ESPECÃÂFICOS */
        .play-again-button,
        #skip-button-standalone,
        #search-input,
        #artist-search-input,
        .suggestion-item {
            font-family: 'PoppinsFont', sans-serif !important;
        }

        #search-input::placeholder,
        #artist-search-input::placeholder {
            font-family: 'PoppinsFont', sans-serif !important;
            opacity: 0.8;
            /* Asegurar legibilidad */
        }

        /* ESTILOS POPUP RACHA */
        .streak-popup {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: var(--panel);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 20px;
            /* box-shadow removed for solid look */
            z-index: 2000;
            max-width: 250px;
            font-family: 'PoppinsFont', sans-serif;
            animation: slideInLeft 0.5s ease-out;
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .popup-title {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--white);
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .popup-text {
            font-size: 0.85em;
            color: var(--muted);
            margin-bottom: 15px;
            line-height: 1.3;
        }

        .claim-button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            font-family: 'PoppinsFont', sans-serif;
            transition: background-color 0.2s;
        }

        .claim-button:hover {
            background-color: #4a9e20;
        }

        .close-popup {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            color: var(--muted);
            font-size: 1.5em;
            cursor: pointer;
            line-height: 1;
            padding: 0;
        }

        .close-popup:hover {
            color: var(--white);
        }

        /* MODAL INFO VIDAS */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background-color: var(--panel);
            border: 2px solid var(--grisesito);
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            position: relative;
            font-family: 'PoppinsFont', sans-serif;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            animation: popIn 0.3s ease-out;
        }

        .modal-content h2 {
            margin-top: 0;
            color: var(--white);
            margin-bottom: 15px;
        }

        .modal-content p {
            color: var(--muted);
            margin-bottom: 20px;
            font-size: 0.95em;
        }

        .life-milestones {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
        }

        .life-milestones li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 6px 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .milestone-badge {
            background-color: var(--accent);
            color: white;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 6px;
            min-width: 30px;
            text-align: center;
            font-size: 0.9em;
        }

        .milestone-hearts {
            display: flex;
            gap: 5px;
        }

        .milestone-hearts img {
            width: 22px;
            height: 22px;
            object-fit: contain;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: var(--muted);
            font-size: 1.8em;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            transition: color 0.2s;
        }

        .close-modal:hover {
            color: var(--white);
        }

        /* === VOLUMEN Y MENÃÅ¡ MÃâVIL === */
        .volume-container-desktop {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        #volume-slider {
            width: 100px;
            height: 4px;
            border-radius: 2px;
            accent-color: var(--grisesito);
            cursor: pointer;
            visibility: visible;
        }

        .mobile-menu-container {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 2000;
            display: none;
        }

        #mobile-menu-btn {
            background: var(--panel);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--white);
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        #mobile-menu-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background: var(--panel);
            border-radius: 8px;
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            min-width: 140px;
        }

        #mobile-menu-dropdown.show {
            display: flex;
        }

        #mobile-menu-dropdown button {
            background: transparent;
            border: none;
            color: var(--white);
            text-align: left;
            padding: 8px 12px;
            font-family: 'PoppinsFont', sans-serif;
            font-size: 0.95em;
            cursor: pointer;
            border-radius: 4px;
        }

        #mobile-menu-dropdown button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Responsive Visibility */
        @media (max-width: 768px) {
            .volume-container-desktop {
                display: none;
            }

            .mobile-menu-container {
                display: block;
            }

            .desktop-only {
                display: none !important;
            }
        }

        /* Mobile Layout Fixes */
        @media (max-width: 480px) {
            .progress-wrapper {
                max-width: 100%;
                box-sizing: border-box;
                padding: 0;
                margin-bottom: 20px;
            }

            .mode-artist-container {
                max-width: 100%;
            }

            /* Tighten up layout to avoid scroll */
            header .logo {
                font-size: 2.2em;
                margin-bottom: 0;
            }

            main {
                margin-top: 5px;
                padding-bottom: 10px;
            }

            #streak {
                margin-bottom: 15px;
                margin-top: 0;
            }

            .play-button {
                margin-bottom: 15px;
                margin-top: 0;
            }

            /* Adjust buttons inside menu if needed, but they are in dropdown now */
        }



        /* === SHARE CARD STYLES === */
        #share-container {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--panel);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 20px;
            z-index: 2147483647;
            /* MAX INT to ensure visibility over any modal */
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: slideInRight 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 300px;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translate(100%, -50%);
            }

            to {
                opacity: 1;
                transform: translate(0, -50%);
            }
        }

        #share-container h2 {
            margin: 0;
            color: var(--white);
            font-size: 1.2em;
            text-align: center;
        }

        #canvas-preview-wrapper {
            background: #1e1e1e;
            padding: 5px;
            border-radius: 8px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        #share-preview {
            max-width: 100%;
            border-radius: 4px;
            display: block;
            width: 200px;
            /* TamaÃÂ±o preview */
            height: auto;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        .share-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'PoppinsFont', sans-serif;
            font-size: 0.9em;
            color: white;
            transition: opacity 0.2s;
        }

        #btn-share-twitter {
            background: #000000;
        }

        /* X black */
        #btn-download-img {
            background: var(--accent);
        }

        .share-btn:hover {
            opacity: 0.9;
        }

        /* Mobile Share Button (Inside Modal) */
        .share-button-mobile {
            background-color: #000000;
            color: white;
            margin-top: 10px;
            border: 1px solid #333;
            display: none;
            /* Controlled by JS via media query logic? No, JS will toggle display */
        }

        /* Mobile Share Button Custom Style */
        .share-button-mobile-style {
            background-color: #1e1e1e !important;
            color: var(--white) !important;
            font-family: 'PoppinsFont', sans-serif !important;
            border: 1px solid #333 !important;
        }

        /* Hide Desktop Container on Mobile - REPLACED WITH ANIMATION LOGIC */
        @media (max-width: 768px) {
            #share-container {
                /* display controlled by JS (flex/none) */
                left: 50%;
                right: auto;
                top: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 350px;
                animation: fadeInModal 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            }

            /* Backdrop for mobile */
            #share-container::before {
                content: "";
                position: fixed;
                top: -100vh;
                left: -100vw;
                width: 300vw;
                height: 300vh;
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px);
                z-index: -1;
                pointer-events: all;
            }
        }

        @keyframes fadeInModal {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
    </style>
</head>


<header>
    <div class="logo">UnderLess</div>
    <img id="emote-7tv" src="img/peepo-band.gif" alt="peepo band">

    <!-- MODE SELECTOR + ARTIST DISPLAY CONTAINER -->
    <div class="mode-artist-container">
        <div class="mode-selector">
            <button id="mode-normal" class="mode-button active" onclick="switchMode('normal')">Normal</button>
            <button id="mode-artist" class="mode-button" onclick="switchMode('artist')">Artista</button>
            <button id="mode-album" class="mode-button" onclick="switchMode('album')">Album</button>
        </div>
    </div>
</header>

<div id="ui-root">
</div>



<!-- MOBILE MENU (PHONE) -->
<div class="mobile-menu-container" id="mobile-menu-container">
    <button id="mobile-menu-btn" onclick="toggleMobileMenu()">
        <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
            <path
                d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" />
        </svg>
    </button>
    <div id="mobile-menu-dropdown">
        <button onclick="openRecommendModal(); toggleMobileMenu()">Recomendar temas</button>
        <button onclick="openBugsModal(); toggleMobileMenu()">Report bugs</button>
    </div>
</div>

<button class="recommend-btn desktop-only" onclick="openRecommendModal()">recomendar</button>
<button class="bugs-btn desktop-only" onclick="openBugsModal()">bugs</button>

<!-- RECOMMEND MODAL -->
<div id="recommend-modal">
    <div class="modal-box">
        <button class="close-x" onclick="closeRecommendModal()">x</button>
        <h3>recomendar artistas/temas/albumes</h3>
        <p>¿tenés artistas o canciones para agregar al juego?</p>
        <p>comentalas en este tweet:</p>
        <a href="https://x.com/Invalame/status/1997739527235047739" target="_blank" class="twitter-link">abrir tweet</a>
    </div>
</div>

<!-- BUGS MODAL -->
<div id="bugs-modal">
    <div class="modal-box">
        <button class="close-x" onclick="closeBugsModal()">x</button>
        <h3>arreglar bugs</h3>
        <p>apretá <kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>R</kbd> para borrar el caché y recargar.</p>
        <p>otros bugs? comentalos en este tweet:</p>
        <a href="https://x.com/Invalame/status/1997739583501717877" target="_blank" class="twitter-link">abrir tweet</a>
    </div>
</div>


<!-- YOUTUBE BUTTON -->
<div class="youtube-container">
    <a href="https://www.youtube.com/@UnderLesss" target="_blank" rel="noopener noreferrer" class="youtube-btn"
        aria-label="YouTube Channel">
        <svg viewBox="0 0 24 24" fill="white" width="24" height="24">
            <path
                d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z" />
        </svg>
    </a>
</div>

<style>
    .youtube-container {
        position: fixed;
        top: 15px;
        right: 30px;
        z-index: 100;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .youtube-btn {
        width: 35px;
        height: 35px;
        background: #ff0000;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.2s, background-color 0.2s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        text-decoration: none;
    }

    .youtube-btn:hover {
        transform: scale(1.1);
        background: #cc0000;
    }

    .youtube-container .tooltip {
        visibility: hidden;
        width: max-content;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 4px;
        padding: 5px 10px;
        position: absolute;
        top: 100%;
        right: 0;

        margin-top: 5px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.8em;
        pointer-events: none;
        white-space: nowrap;
    }

    /* Adjust body min-height to avoid scroll on exact fit */
    body {
        min-height: 100vh;
        /* Ensure no scrollbar appears if content fits */
        height: 100%;
        overflow-y: auto;
        /* Allow scroll if needed */
    }

    .search-controls-container {
        margin-bottom: 0 !important;
        padding-bottom: 0 !important;
    }

    .youtube-container:hover .tooltip {
        visibility: visible;
        opacity: 1;
    }

    /* Mobile adjustments */
    @media (max-width: 480px) {
        .youtube-container {
            right: 15px;
            top: 55px;
            align-items: center;
        }

        .youtube-container .tooltip {
            right: auto;
            left: 50%;
            transform: translateX(-50%);
        }
    }

    /* LOADER ANIMATION */
    .loader {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid #ffffff;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }

    }

    /* FINAL OVERRIDES to ensure User Preferences */
    .search-input {
        font-family: 'PoppinsFont', sans-serif !important;
        /* Force correct font */
    }

    .progress-wrapper,
    .progress-bar-container {
        width: 100% !important;
        max-width: none !important;
        min-width: 100% !important;
        box-sizing: border-box !important;
    }

    /* REVERT: Constrain guess boxes and search controls back to original compact size */
    .guess-boxes {
        max-width: 700px !important;
        /* Widened to 700px as requested */
        /* Restore original narrow look */
        margin-left: auto !important;
        margin-right: auto !important;
    }

    .search-controls-container {
        max-width: 800px !important;
        /* Wider than guess boxes (600px) */
        margin-left: auto !important;
        margin-right: auto !important;
    }
</style>

<main>
    <!-- SECCIÃâN DE ARTISTA -->
    <div id="artist-section">
        <div id="current-artist-display">Selecciona un artista</div>
        <div class="artist-search-container">
            <div class="search-container">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path
                        d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20.29 21l.71-.71L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5z" />
                </svg>
                <input type="text" class="search-input" id="artist-search-input" placeholder="Buscar artista..."
                    autocomplete="off">
            </div>
            <div id="artist-list" class="songs-list"></div>
        </div>
    </div>

    <!-- SECCIÃâN DE ÃÂLBUM -->
    <div id="album-section">
        <div class="artist-search-container"> <!-- Reutilizamos estilos containers -->
            <div class="search-container">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z" />
                </svg>
                <input type="text" class="search-input" id="album-search-input" placeholder="Buscar álbum..."
                    autocomplete="off">
            </div>
            <div id="album-list" class="songs-list"></div>
        </div>
    </div>



    <!-- GAME BOARD WRAPPER: Provides stable anchor context -->
    <div class="game-board-wrapper">

        <div class="guess-boxes" id="guess-boxes">
            <div class="guess-box"></div>
            <div class="guess-box"></div>
            <div class="guess-box"></div>
            <div class="guess-box"></div>
            <div class="guess-box"></div>
            <div class="guess-box"></div>
        </div>


        <div class="progress-wrapper">
            <div class="progress-bar-container" id="progress-bar">
                <div class="segments-overlay" id="segments-overlay"></div>
                <div class="progress-bar-fill" id="progress-bar-fill"></div>
            </div>
            <span class="timer-text" id="current-timer-text" style="left:0%">0.1s</span>
        </div>

        <!-- ALBUM ART DISPLAY CONTAINER - Anchored to .game-board-wrapper -->
        <div id="album-art-container">
            <div id="album-label">ALBUM ELEGIDO</div>
            <img id="album-art-display" src="" alt="Album Art">
            <div id="album-name-display"></div>
        </div>

        <button class="play-button" id="play-button" onclick="playSnippet()" disabled aria-label="escuchar fragmento">
            <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M8 5v14l11-7z" fill="white" stroke="white" stroke-width="2" stroke-linejoin="round" />
            </svg>
        </button>
        <div id="streak">Racha: 0</div>

        <div class="search-controls-container">
            <div class="controls-row">
                <div class="search-container" id="search-container">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path
                            d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20.29 21l.71-.71L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                    </svg>
                    <input type="text" class="search-input" id="search-input" placeholder="Busca un banger..."
                        autocomplete="off">
                    <div id="songs-list" class="songs-list" aria-hidden="true"></div>
                </div>
                <button id="skip-button-standalone" onclick="handleSkip()">Skip</button>
            </div>
            <!-- STREAK SAVERS MOVED HERE -->
            <div id="streak-saver-ui" onclick="openLifeModal()" style="cursor: pointer;" title="Ver info de vidas">
                salvadores de racha: 3
            </div>
        </div>

    </div> <!-- End game-board-wrapper -->
</main>

<!-- POPUP RECLAMAR RACHA -->
<div id="streak-claim-popup" class="streak-popup" style="display: none;">
    <button class="close-popup" onclick="closeClaimPopup()">x</button>
    <div class="popup-title">Reclamar 25 de racha</div>
    <div class="popup-text">Por la cantidad de bugs te regalamos esto</div>
    <button class="claim-button" onclick="claimStreak()">Reclamar</button>
</div>

<!-- MODAL INFO VIDAS -->
<div id="life-info-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <button class="close-modal" onclick="closeLifeModal()">x</button>
        <h2>Sistema de Vidas</h2>
        <p>Consigue vidas extra al alcanzar estas rachas:</p>
        <ul class="life-milestones">
            <li>
                <span class="milestone-badge" style="background-color: #55b725; color: #ffffff;">10</span>
                <div class="milestone-hearts">
                    <img src="img/racha_color.png"><img src="img/racha_nocolor.png"><img
                        src="img/racha_nocolor.png"><img src="img/racha_nocolor.png">
                </div>
            </li>
            <li>
                <span class="milestone-badge" style="background-color: #ff9900;">20</span>
                <div class="milestone-hearts">
                    <img src="img/racha_color.png"><img src="img/racha_color.png"><img src="img/racha_nocolor.png"><img
                        src="img/racha_nocolor.png">
                </div>
            </li>
            <li>
                <span class="milestone-badge" style="background-color: #8a2be2;">40</span>
                <div class="milestone-hearts">
                    <img src="img/racha_color.png"><img src="img/racha_color.png"><img src="img/racha_color.png"><img
                        src="img/racha_nocolor.png">
                </div>
            </li>
            <li>
                <span class="milestone-badge" style="background-color: #2b90e2;">100</span>
                <div class="milestone-hearts">
                    <img src="img/racha_color.png"><img src="img/racha_color.png"><img src="img/racha_color.png"><img
                        src="img/racha_color.png">
                </div>
            </li>
        </ul>
    </div>
</div>

<div id="game-over-message" role="dialog" aria-modal="true">
    <div class="game-over-content" id="game-over-content">
        <div class="game-over-header">
            <h2 id="game-result"></h2>
        </div>

        <div class="game-over-body">
            <div id="correct-answer-container">
                <span class="label" id="answer-label"></span>
                <span id="correct-answer"></span>
            </div>

            <div class="full-player-container">
                <div class="full-player-bar">
                    <input type="range" id="full-song-seeker" min="0" max="100" value="0">
                </div>
                <div class="full-player-controls">
                    <button class="action-button mini-play-button" id="full-song-toggle" onclick="toggleFullSong()">
                        <span id="full-song-icon-play">
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                        </span>
                        <span id="full-song-icon-pause" style="display: none;">
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                            </svg>
                        </span>
                    </button>
                    <span id="full-song-time">0:00 / 0:00</span>
                </div>
            </div>
            <button class="action-button play-again-button" onclick="resetGame(true)">una ma</button>
            <button id="mobile-share-btn" class="action-button share-button-mobile-style"
                style="display:none; margin-top: 10px;" onclick="triggerMobileShare()">compartir racha</button>
        </div>
    </div>
</div>
</div>
<!-- SHARE CONTAINER (DESKTOP) -->
<div id="share-container">
    <button class="close-popup" onclick="closeShareContainer()">X</button>
    <h2>Compartí tu racha!</h2>
    <div id="canvas-preview-wrapper">
        <img id="share-preview" alt="Resultado">
    </div>
    <div class="share-buttons">
        <button id="btn-download-img" class="share-btn">Descargar</button>
    </div>
</div>
<!-- CANVAS OCULTO PARA GENERACIÃâN -->
<canvas id="share-canvas" width="600" height="750" style="display: none;"></canvas>

<!-- Removed audio tag from DOM -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<!-- STREAK WARNING NOTIFICATION -->
<div id="streak-warning">Ya adivinaste esta canción. No suma racha.</div>

<!-- DATA - Must load before main script -->
<script src="data.js"></script>

<script>

    // -----------------------------------------------------
    // Variables

    // -----------------------------------------------------
    // Variables
    let audioPlayer = new Audio(); // Created in memory, not in DOM
    let currentSong = {};
    let guessCount = 0;

    // VARIABLE GLOBAL PARA EL COMANDO SECRETO
    window.kinoUnlocked = false;

    // Duraciones de intentos (DINÃÂMICO)
    function getDurations() {
        if (currentMode === 'artist' || currentMode === 'album') {
            return [0.1, 0.5, 2, 6];
        }
        return [0.1, 0.5, 2, 4, 8, 15];
    }

    function getTotalGameDuration() {
        const durations = getDurations();
        return durations[durations.length - 1];
    }


    let hasGuessedCorrectly = false;
    let availableSongs = [];



    // Snippet playback state
    let snippetState = 'idle'; // 'idle' | 'playing' | 'paused'
    let snippetTargetTime = 0; // The exact audio time where snippet should stop
    let animationFrameId = null; // For requestAnimationFrame cleanup

    // Core audio variables
    let gameStartTime = 0; // Random start point within the song
    let isFullSongPlaying = false;
    let fullPlayerInterval = null;
    let isGameOver = false; // Moved here for global access


    audioPlayer.addEventListener('timeupdate', () => {
        if (snippetState === 'playing' && !isGameOver) {
            if (audioPlayer.currentTime >= snippetTargetTime) {
                finishSnippet();
            }
        }
    });

    // nuevo: historial para evitar repeticiÃÂ³n entre juegos.
    let lastTwoIndices = [-1, -1]; // almacena los ÃÂ­ndices de las dos ÃÂºltimas canciones jugadas de 'biblioteca'
    let currentBlobUrl = null; // Para ocultar la URL del archivo

    // HISTORIAL PERSISTENTE DE CANCIONES JUGADAS
    // Se guardan los nombres de las canciones ya jugadas para no repetir hasta completar la lista
    let playedSongsNormal = JSON.parse(localStorage.getItem('playedSongsNormal')) || [];
    let playedSongsArtist = JSON.parse(localStorage.getItem('playedSongsArtist')) || [];

    // NUEVO: Sistema de rachas
    let winStreak = parseInt(localStorage.getItem('winStreak')) || 0;
    let artistStreak = parseInt(localStorage.getItem('artistStreak')) || 0; // NUEVO
    const streakEl = document.getElementById('streak');

    // NUEVO: Sistema salva rachas
    let streaksavers = parseInt(localStorage.getItem('streaksavers')) || 0;
    const minstreak = 13;

    // NUEVO: Variables para Modo Artista
    let currentMode = 'normal'; // 'normal' | 'artist'
    let selectedArtist = null;
    let artists = new Set();
    let artistList = []; // Array ordenado de artistas para bÃÂºsqueda

    // NUEVO: Variables para Modo ÃÂlbum
    let selectedAlbum = null;
    let albumList = []; // Array de nombres de Ã¡lbumes
    let currentAlbumSongs = []; // Canciones del Ã¡lbum seleccionado

    // dom
    const playButton = document.getElementById('play-button');
    const skipButton = document.getElementById('skip-button-standalone');
    const searchInput = document.getElementById('search-input');
    const songsList = document.getElementById('songs-list');
    const progressBarFill = document.getElementById('progress-bar-fill');
    const segmentsOverlay = document.getElementById('segments-overlay');
    const timerTextEl = document.getElementById('current-timer-text');
    const volumeSlider = document.getElementById('volume-slider');
    const gameOverMessage = document.getElementById('game-over-message');
    const gameOverContent = document.getElementById('game-over-content'); // nuevo
    const gameResult = document.getElementById('game-result');
    const answerLabel = document.getElementById('answer-label'); // nuevo
    const correctAnswerEl = document.getElementById('correct-answer'); // renombrado

    // nuevos elementos del reproductor completo
    const fullSongIconPlay = document.getElementById('full-song-icon-play');
    const fullSongIconPause = document.getElementById('full-song-icon-pause');
    const fullSongSeeker = document.getElementById('full-song-seeker');
    const fullSongTime = document.getElementById('full-song-time');

    // elementos modo artista
    const artistSection = document.getElementById('artist-section');
    const artistSearchInput = document.getElementById('artist-search-input');
    const artistListEl = document.getElementById('artist-list');
    const currentArtistDisplay = document.getElementById('current-artist-display');
    const currentArtistDisplayHeader = document.getElementById('current-artist-display-header');
    const modeNormalBtn = document.getElementById('mode-normal');
    const modeArtistBtn = document.getElementById('mode-artist');
    const modeAlbumBtn = document.getElementById('mode-album');

    // elementos modo album
    const albumSection = document.getElementById('album-section');
    const albumSearchInput = document.getElementById('album-search-input');
    const albumListEl = document.getElementById('album-list');
    const currentAlbumDisplay = document.getElementById('current-album-display');
    const albumArtDisplay = document.getElementById('album-art-display');

    // iconos svg para el boton (con bordes redondeados sutiles)
    const iconPlay = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z" stroke="white" stroke-width="2" stroke-linejoin="round" /></svg>';
    const iconPause = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" stroke="white" stroke-width="2" stroke-linejoin="round" /></svg>';

    // SOUND EFFECTS
    const soundClick = new Audio('sounds/sound_click.mp3');
    const soundGameOver = new Audio('sounds/sound_game_over.mp3');

    function playSound(type) {
        // Reset to start to allow rapid re-play
        if (type === 'click') {
            soundClick.currentTime = 0;
            soundClick.play().catch(e => console.warn('Error playing click sound:', e));
        } else if (type === 'gameover') {
            soundGameOver.currentTime = 0;
            soundGameOver.play().catch(e => console.warn('Error playing gameover sound:', e));
        }
    }

    // -----------------------------------------------------
    // helpers
    function formatSeconds(value) {
        // CORREGIDO: Number.isInteger, toFixed
        return Number.isInteger(value) ? `${value}s` : `${value.toFixed(1)}s`;
    }

    // nueva funciÃÂ³n: formatear tiempo a mm:ss
    function formatTime(seconds) {
        if (isNaN(seconds) || seconds < 0) return "0:00";
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
    }

    // calcula el porcentaje en la barra basado en el tiempo total del juego
    function getPercentage(timeinseconds) {
        return (timeinseconds / getTotalGameDuration()) * 100;
    }

    // Helper para actualizar el display del artista en el header
    function updateArtistHeaderDisplay(artistName) {
        if (!currentArtistDisplayHeader) return;

        if (artistName && currentMode === 'artist') {
            currentArtistDisplayHeader.textContent = artistName;
            currentArtistDisplayHeader.classList.add('show');
        } else {
            currentArtistDisplayHeader.textContent = '';
            currentArtistDisplayHeader.classList.remove('show');
        }
    }

    // visual: renderiza las divisiones de la barra de progreso
    function renderProgressSegments() {
        if (!segmentsOverlay) return;
        segmentsOverlay.innerHTML = "";
        const durations = getDurations();
        const total = getTotalGameDuration();

        let previousCumulativeTime = 0;
        durations.forEach((cumulativeTime, index) => {
            const segmentTime = cumulativeTime - previousCumulativeTime;

            const segment = document.createElement('div');
            segment.classList.add('progress-segment');
            segment.style.width = `${(segmentTime / total) * 100}%`;
            segmentsOverlay.appendChild(segment);
            previousCumulativeTime = cumulativeTime;

            if (index < durations.length - 1) {
                const percentage = getPercentage(cumulativeTime);

                const divider = document.createElement('div');
                divider.classList.add('segment-divider');

                // FIX: Visual adjustment for the first divider (0.1s)
                if (index === 0) {
                    divider.style.left = `calc(${percentage}% + 3px)`; // Shift right slightly
                } else {
                    divider.style.left = `${percentage}%`;
                }

                segmentsOverlay.appendChild(divider);
            }
        });
    }

    // NUEVO: Renderizar cajas de intentos dinÃ¡micamente
    function renderGuessBoxes() {
        const container = document.getElementById('guess-boxes');
        if (!container) return;
        container.innerHTML = '';

        const durations = getDurations();
        const count = durations.length;

        for (let i = 0; i < count; i++) {
            const box = document.createElement('div');
            box.className = 'guess-box';
            container.appendChild(box);
        }
    }

    // FUNCIÃâN MEJORADA PARA RACHA CON DEGRADADO PROGRESIVO SUAVE
    function updateStreakDisplay() {
        const currentStreak = currentMode === 'normal' ? winStreak : artistStreak;
        streakEl.textContent = `Racha: ${currentStreak}`;

        let color = '';

        if (currentStreak === 0) {
            color = 'var(--muted)'; // gris
        }
        else if (currentStreak <= 5) {
            // Verde puro a verde-amarillo (1-5)
            const progress = (currentStreak - 1) / 4; // 0 a 1
            color = lerpColor("#55b725", "#7db800", progress);
        }
        else if (currentStreak <= 10) {
            // Verde-amarillo a amarillo brillante (6-10)
            const progress = (currentStreak - 5) / 5;
            color = lerpColor("#7db800", "#ffd000", progress);
        }
        else if (currentStreak <= 15) {
            // Amarillo a naranja (11-15)
            const progress = (currentStreak - 10) / 5;
            color = lerpColor("#ffd000", "#ff8800", progress);
        }
        else if (currentStreak <= 20) {
            // Naranja a rojo (16-20)
            const progress = (currentStreak - 15) / 5;
            color = lerpColor("#ff8800", "#ff3300", progress);
        }
        else if (currentStreak <= 25) {
            // Rojo a rojo oscuro (21-25)
            const progress = (currentStreak - 20) / 5;
            color = lerpColor("#ff3300", "#990000", progress);
        }
        else if (currentStreak <= 30) {
            // Rojo oscuro a violeta suave (26-30)
            const progress = (currentStreak - 25) / 5;
            color = lerpColor("#990000", "#b14aed", progress);
        }
        else if (currentStreak <= 35) {
            // Violeta suave a violeta intenso (31-35)
            const progress = (currentStreak - 30) / 5;
            color = lerpColor("#b14aed", "#8a2be2", progress);
        }
        else if (currentStreak <= 99) {
            // 36-99: violeta intenso con glow
            color = 'var(--streak-max)';
            streakEl.style.textShadow = '0 0 12px rgba(138, 43, 226, 0.7)';
        }
        else {
            // 100 o mÃ¡s: celeste piola con glow mÃ¡s intenso
            color = 'var(--streak-cyan)';
            streakEl.style.textShadow = '0 0 15px rgba(0, 212, 255, 0.8)';
        }

        streakEl.style.color = color;

        // Quitar el brillo cuando la racha es menor a 36
        if (currentStreak < 36) {
            streakEl.style.textShadow = 'none';
        }
    }

    // FunciÃÂ³n auxiliar para interpolar colores (degradado suave)
    function lerpColor(color1, color2, factor) {
        const hex = (c) => {
            const hex = c.replace('#', '');
            return [parseInt(hex.substr(0, 2), 16), parseInt(hex.substr(2, 2), 16), parseInt(hex.substr(4, 2), 16)];
        };
        const rgb1 = hex(color1);
        const rgb2 = hex(color2);
        const result = rgb1.map((c, i) => Math.round(c + factor * (rgb2[i] - c)));
        return `rgb(${result[0]}, ${result[1]}, ${result[2]})`;
    }

    function updateStreakSaverUI() {
        const streakSaverEl = document.getElementById('streak-saver-ui');
        if (!streakSaverEl) return;

        // En modo artista no usamos salva rachas
        if (currentMode === 'artist' || currentMode === 'album') {
            streakSaverEl.style.display = 'none';
            return;
        }

        const currentStreak = winStreak;

        if (currentStreak < minstreak) {
            streakSaverEl.style.display = 'none';
            return;
        }

        streakSaverEl.style.display = 'flex';
        let html = 'Vidas: ';
        const maxSavers = 3;
        for (let i = 0; i < maxSavers; i++) {
            const src = (i < streaksavers) ? 'img/racha_color.png' : 'img/racha_nocolor.png';
            html += `<img src="${src}" alt="salva racha">`;
        }
        streakSaverEl.innerHTML = html;
    }

    // -----------------------------------------------------
    // LÃâGICA MODO ARTISTA

    function extractArtist(songName) {
        // El artista son las palabras que esten antes de una "," o un "-"
        // Prioridad: coma, luego guion.
        let separatorIndex = songName.indexOf(',');
        if (separatorIndex === -1) {
            separatorIndex = songName.indexOf('-');
        }

        if (separatorIndex !== -1) {
            return songName.substring(0, separatorIndex).trim();
        }
        return ""; // Fallback o si no tiene separador (raro en este formato)
    }

    // NUEVO: Helper especÃÂ­fico para la lÃÂ³gica de "guess box amarilla"
    // Solo considera el guion como separador, ignorando comas.
    function extractArtistForGuess(songName) {
        let separatorIndex = songName.indexOf('-');
        if (separatorIndex !== -1) {
            return songName.substring(0, separatorIndex).trim();
        }
        return "";
    }

    function populateArtists() {
        artists.clear();
        // Usar bibliotecaArtist para poblar la lista de artistas
        bibliotecaArtist.forEach(song => {
            // EXCLUDE TROLL SONGS
            if (song.nombre === "Matias Fisher - Muerte en Halloween" ||
                song.nombre === "Chiki Wanted - que es el under" ||
                song.nombre === "PILF - ENTRO A LA CANCHA" ||
                song.nombre === "PILF - FUMO UNO FUMO DOS" ||
                song.nombre === "PILF - HIT" ||
                song.nombre === "PILF - TANTA GIRA" ||
                song.nombre === "Red Shine, MAGNESIO - ELDEN RING" ||
                song.nombre === "papirola - sos mi papirola") {
                return;
            }

            // COMANDO SECRETO: Ocultar kino frizza por defecto
            if (song.nombre.toLowerCase().includes("kino frizza") && !window.kinoUnlocked) {
                return;
            }
            const artist = extractArtist(song.nombre);
            if (artist) {
                artists.add(artist);
            }

            // COMANDO SECRETO DE CONSOLA
            window.comandoKino = function () {
                window.kinoUnlocked = true;
                populateArtists();

                // Intentar actualizar la UI (si existe el selector)
                // Como no tengo el ID exacto del selector, asumimos que al cambiar de modo se refresca
                // o llamamos a init/render si fuera accesible.
                // Pero populateArtists actualiza la lista global 'artistList', asÃÂ­ que cualquier
                // renderizado subsecuente lo tomarÃ¡.

                // Forzar actualizaciÃÂ³n si estamos en modo artista
                if (typeof renderModeSelector === 'function') {
                    renderModeSelector();
                } else {
                    // Fallback: Intentar disparar evento si existe
                    console.log("Artista 'kino frizza' desbloqueado. Si no aparece, cambia de modo y vuelve a entrar.");
                }

                console.log("%c DESBLOQUEASTE EL FRICHO", "color: gold; font-size: 20px; font-weight: bold;");
                return "juga con las parodias de la cabra";
            };
        });
        artistList = Array.from(artists).sort((a, b) => a.localeCompare(b));
    }

    // -----------------------------------------------------
    // LÃâGICA MODO ÃÂLBUM

    function populateAlbums() {
        albumList = albumsData.map(a => a.name).sort((a, b) => a.localeCompare(b));
    }

    function filterAlbums(query) {
        if (!query) return albumList;
        const lowerQuery = query.toLowerCase();
        return albumList.filter(name => name.toLowerCase().includes(lowerQuery));
    }

    function renderAlbumSuggestions(list) {
        albumListEl.innerHTML = "";
        if (list && list.length > 0) {
            list.forEach(albumName => {
                const albumInfo = albumsData.find(a => a.name === albumName);
                const div = document.createElement('div');
                div.className = 'album-item';

                const textSpan = document.createElement('span');
                textSpan.className = 'album-item-text';
                textSpan.textContent = albumName;

                const img = document.createElement('img');
                img.className = 'album-item-image';
                if (albumInfo && albumInfo.cover) {
                    img.src = albumInfo.cover;
                    img.alt = albumName;
                } else {
                    img.style.display = 'none';
                }

                div.appendChild(textSpan);
                div.appendChild(img);
                div.onclick = () => selectAlbum(albumName);
                albumListEl.appendChild(div);
            });
            albumListEl.classList.add('show');
        } else {
            albumListEl.classList.remove('show');
        }
    }

    async function selectAlbum(albumName) {
        if (selectedAlbum === albumName) {
            albumListEl.classList.remove('show');
            return;
        }

        selectedAlbum = albumName;
        albumSearchInput.value = albumName;
        albumSearchInput.classList.add('centered-text');
        albumListEl.classList.remove('show');

        const albumInfo = albumsData.find(a => a.name === albumName);
        if (albumInfo) {
            availableSongs = [...albumInfo.songs];

            // Update album art container
            const container = document.getElementById('album-art-container');
            const albumNameDisplay = document.getElementById('album-name-display');
            const albumArtDisplay = document.getElementById('album-art-display');

            if (albumInfo.cover && container && albumArtDisplay && albumNameDisplay) {
                albumArtDisplay.src = albumInfo.cover;
                albumNameDisplay.textContent = albumName;
                container.classList.add('show');
            } else if (container) {
                container.classList.remove('show');
            }
        } else {
            availableSongs = [];
            const container = document.getElementById('album-art-container');
            if (container) container.classList.remove('show');
        }

        saveModeState('album');
        resetGame(true);
    }

    // Event Listeners para bÃÂºsqueda de Ã¡lbum
    if (albumSearchInput) {
        albumSearchInput.addEventListener('input', (e) => {
            const query = e.target.value;
            const matches = query ? filterAlbums(query) : albumList;
            renderAlbumSuggestions(matches);
        });

        albumSearchInput.addEventListener('click', () => {
            if (albumList.length === 0) populateAlbums();
            albumSearchInput.classList.remove('centered-text');
            const query = albumSearchInput.value;
            const matches = query ? filterAlbums(query) : albumList;
            renderAlbumSuggestions(matches);
        });

        albumSearchInput.addEventListener('focus', () => {
            albumSearchInput.classList.remove('centered-text');
        });

        albumSearchInput.addEventListener('blur', () => {
            if (selectedAlbum && albumSearchInput.value === selectedAlbum) {
                albumSearchInput.classList.add('centered-text');
            }
        });
    }

    // Close dropdown on outside click
    document.addEventListener('click', (e) => {
        if (albumSearchInput && albumListEl) {
            if (!albumSearchInput.contains(e.target) && !albumListEl.contains(e.target)) {
                albumListEl.classList.remove('show');
            }
        }
    });

    // PERSISTENCIA DE ESTADO
    let normalModeState = null;
    let artistModeState = null;
    let albumModeState = null;

    function saveModeState(mode) {
        const state = {
            currentSong: currentSong,
            guessCount: guessCount,
            hasGuessedCorrectly: hasGuessedCorrectly,
            availableSongs: [...availableSongs],
            guesses: getGuessStates(), // Guardar estado visual
            gameStartTime: gameStartTime // Guardar tiempo de inicio aleatorio
        };

        if (mode === 'artist') {
            state.selectedArtist = selectedArtist;
            artistModeState = state;
        } else if (mode === 'album') {
            state.selectedAlbum = selectedAlbum;
            albumModeState = state;
        } else {
            normalModeState = state;
        }

        // PERSISTENCIA: Guardar en localStorage
        const fullState = {
            normal: normalModeState,
            artist: artistModeState,
            album: albumModeState,
            currentMode: currentMode,
            wonSongsInStreak: Array.from(wonSongsInStreak) // Convert Set to Array
        };
        localStorage.setItem('underless_save_v1', JSON.stringify(fullState));
    }

    // --- UNIQUE STREAK LOGIC ---
    let wonSongsInStreak = new Set(); // Stores song names already won in current streak

    function showStreakWarning() {
        const warning = document.getElementById('streak-warning');
        if (warning) {
            warning.classList.add('show');
            setTimeout(() => {
                warning.classList.remove('show');
            }, 2200); // reduced from 3.5s
        }
    }

    function loadFromLocalStorage() {
        const saved = localStorage.getItem('underless_save_v1');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                normalModeState = parsed.normal;
                artistModeState = parsed.artist;
                albumModeState = parsed.album;
                if (parsed.currentMode) {
                    currentMode = parsed.currentMode;
                }

                // Load won songs set
                if (parsed.wonSongsInStreak) {
                    wonSongsInStreak = new Set(parsed.wonSongsInStreak);
                } else {
                    wonSongsInStreak = new Set();
                }

            } catch (e) {
                console.error("Error loading game state:", e);
                localStorage.removeItem('underless_save_v1');
            }
        }
    }

    async function restoreModeState(mode) {
        let state;
        if (mode === 'artist') state = artistModeState;
        else if (mode === 'album') state = albumModeState;
        else state = normalModeState;

        renderGuessBoxes();
        renderProgressSegments();

        if (!state) {
            // Si no hay estado guardado, resetear de cero
            availableSongs = [];
            if (mode === 'artist') selectedArtist = null;
            if (mode === 'album') selectedAlbum = null;
            resetGame(true);
            return;
        }

        // Restaurar variables
        currentSong = state.currentSong;
        guessCount = state.guessCount;
        hasGuessedCorrectly = state.hasGuessedCorrectly;
        availableSongs = state.availableSongs;
        if (mode === 'artist') {
            selectedArtist = state.selectedArtist;
            if (selectedArtist) {
                // currentArtistDisplay.textContent = `Artista: ${selectedArtist}`; 
                // updateArtistHeaderDisplay(selectedArtist); 
                // Set input value to selected artist
                if (artistSearchInput) {
                    artistSearchInput.value = selectedArtist;
                    artistSearchInput.classList.add('centered-text');
                }

                if (availableSongs && availableSongs.length > 0) {
                    const isConsistent = availableSongs.every(s => extractArtist(s.nombre) === selectedArtist);
                    if (!isConsistent) {
                        console.warn("Detected inconsistent songs in artist mode state. Resetting pool.");
                        availableSongs = [];
                    }
                }
            } else {
                // currentArtistDisplay.textContent = "Selecciona un artista";
                // updateArtistHeaderDisplay(null); 
                if (artistSearchInput) artistSearchInput.value = "";
                availableSongs = [];
            }
        } else if (mode === 'album') {
            // Modo álbum
            selectedAlbum = state.selectedAlbum || null;
            if (selectedAlbum) {
                if (albumSearchInput) {
                    albumSearchInput.value = selectedAlbum;
                    albumSearchInput.classList.add('centered-text');
                }

                // Update Album Art Container with labels
                const albumInfo = albumsData.find(a => a.name === selectedAlbum);
                const container = document.getElementById('album-art-container');
                const albumNameDisplay = document.getElementById('album-name-display');
                const albumArtDisplay = document.getElementById('album-art-display');

                if (albumInfo && albumInfo.cover && container && albumArtDisplay && albumNameDisplay) {
                    albumArtDisplay.src = albumInfo.cover;
                    albumNameDisplay.textContent = selectedAlbum;
                    container.classList.add('show');
                }
            } else {
                if (albumSearchInput) albumSearchInput.value = "";
                availableSongs = [];
                const container = document.getElementById('album-art-container');
                if (container) container.classList.remove('show');
            }
        } else {
            // Modo normal
            // updateArtistHeaderDisplay(null);
        }

        // Restaurar casillas visualmente
        const boxes = document.querySelectorAll('.guess-box');
        // Limpiar primero
        boxes.forEach(b => { b.className = 'guess-box'; b.textContent = ''; });

        // NUEVO: Restaurar estado visual exacto
        if (state.guesses) {
            restoreGuessStates(state.guesses);
        } else if (state.guessBoxStates) {
            // Fallback para compatibilidad con versiones anteriores de guardado
            restoreGuessStates(state.guessBoxStates);
        }

        // Restaurar audio con blob para mantener ofuscaciÃÂ³n
        if (currentSong.archivo) {
            // Restaurar el tiempo de inicio aleatorio guardado, o usar 0 por defecto
            gameStartTime = state.gameStartTime !== undefined ? state.gameStartTime : 0;

            // FIX: Limpiar el listener onloadedmetadata de resetGame para evitar que sobrescriba
            // el gameStartTime guardado con un nuevo valor aleatorio
            audioPlayer.onloadedmetadata = () => {
                // Enforce saved start time after metadata loads
                if (isFinite(audioPlayer.duration)) {
                    audioPlayer.currentTime = gameStartTime;
                }
                audioPlayer.onloadedmetadata = null;
            };

            // Cargar canciÃÂ³n con blob (ofuscaciÃÂ³n)
            if (currentBlobUrl) {
                URL.revokeObjectURL(currentBlobUrl);
                currentBlobUrl = null;
            }

            // BUGFIX: Skip fetch on file protocol to avoid console errors (spoilers)
            if (window.location.protocol !== 'file:') {
                try {
                    const response = await fetch(currentSong.archivo);
                    const blob = await response.blob();
                    currentBlobUrl = URL.createObjectURL(blob);
                    audioPlayer.src = currentBlobUrl;
                } catch (e) {
                    console.error("Error loading audio blob:", e);
                    audioPlayer.src = currentSong.archivo;
                }
            } else {
                // Local file: use direct path
                audioPlayer.src = currentSong.archivo;
            }

            audioPlayer.currentTime = gameStartTime;
            audioPlayer.load();

            // Activar botón play cuando el audio esté listo
            audioPlayer.oncanplaythrough = () => {
                audioPlayer.currentTime = gameStartTime;
                playButton.removeAttribute('disabled');
                audioPlayer.oncanplaythrough = null;
            };
            // No reproducimos automÃ¡ticamente, el usuario debe dar play
        } else {
            // Si no habÃÂ­a canciÃÂ³n (ej. artista no seleccionado), resetear UI
            audioPlayer.src = "";
            playButton.setAttribute('disabled', '');
            skipButton.disabled = true;
            if (fullSongTime) fullSongTime.textContent = '0:00 / 0:00';

            if (mode === 'artist' && !selectedArtist) {
                document.getElementById('search-container').classList.add('disabled');
            }
            if (mode === 'album' && !selectedAlbum) {
                document.getElementById('search-container').classList.add('disabled');
            }
        }

        // Actualizar marcador de tiempo
        updateTimeMarker(guessCount);

        // Actualizar estado de botones
        if (hasGuessedCorrectly) {
            document.getElementById('search-container').classList.add('disabled');
            playButton.setAttribute('disabled', '');
            skipButton.disabled = true;
        } else {
            if (currentSong.archivo) {
                document.getElementById('search-container').classList.remove('disabled');
                playButton.removeAttribute('disabled');
                skipButton.disabled = false;
            }
        }

        updateStreakDisplay();
        updateStreakSaverUI();

        // Si el juego terminÃÂ³, mostrar el modal de nuevo
        if (hasGuessedCorrectly) {
            showGameOver(true);
        } else if (guessCount >= getDurations().length) {
            showGameOver(false);
        }
    }


    async function switchMode(mode) {
        playSound('click');
        if (currentMode === mode) return;

        pauseAudioInternal();

        // CRITICAL FIX: Stop everything and CLEAR SOURCE immediately to prevent ghost audio
        audioPlayer.src = "";
        if (currentBlobUrl) {
            URL.revokeObjectURL(currentBlobUrl);
            currentBlobUrl = null;
        }

        // FIX: Reset progress bar visually when switching modes
        if (progressBarFill) progressBarFill.style.width = '0%';

        saveModeState(currentMode);

        currentMode = mode;

        // Actualizar botones y secciones
        modeNormalBtn.classList.toggle('active', mode === 'normal');
        modeArtistBtn.classList.toggle('active', mode === 'artist');
        modeAlbumBtn.classList.toggle('active', mode === 'album');

        artistSection.classList.toggle('show', mode === 'artist');
        if (mode === 'artist') populateArtists();

        albumSection.classList.toggle('show', mode === 'album');
        if (mode === 'album') populateAlbums();

        // Hide album art container if not in album mode
        const albumArtContainer = document.getElementById('album-art-container');
        if (mode !== 'album' && albumArtContainer) {
            albumArtContainer.classList.remove('show');
        }

        // Hide/show lives UI based on mode (no lives in album mode)
        const streakSaverUI = document.getElementById('streak-saver-ui');
        if (streakSaverUI) {
            if (mode === 'album') {
                streakSaverUI.style.display = 'none';
            } else {
                streakSaverUI.style.display = 'block';
            }
        }

        await restoreModeState(mode);
    }

    function filterArtists(query) {
        if (!query) return [];
        const lowerQuery = query.toLowerCase();
        const queryTerms = lowerQuery.split(/\s+/);

        return artistList.filter(artist => {
            const lowerArtist = artist.toLowerCase();
            return queryTerms.every(term => lowerArtist.includes(term));
        });
    }

    function selectArtist(artist) {
        selectedArtist = artist;
        // currentArtistDisplay.textContent = `Artista: ${artist}`;
        // updateArtistHeaderDisplay(artist); 

        // FUSED: Update search input to show selected artist
        artistSearchInput.value = artist;
        artistSearchInput.classList.add('centered-text');

        artistListEl.classList.remove('show');

        // Resetear juego para empezar con el artista seleccionado
        availableSongs = []; // Limpiar pool para obligar a recargar con el nuevo artista
        resetGame(true);
        saveModeState('artist'); // Guardar selecciÃÂ³n de artista
    }

    // Event Listeners para bÃÂºsqueda de artista
    // Helper para renderizar la lista de artistas
    function renderArtistSuggestions(list) {
        artistListEl.innerHTML = '';
        if (list && list.length > 0) {
            list.forEach(artist => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = artist;
                div.onclick = () => selectArtist(artist);
                artistListEl.appendChild(div);
            });
            artistListEl.classList.add('show');
        } else {
            artistListEl.classList.remove('show');
        }
    }

    // Event Listeners para bÃÂºsqueda de artista
    artistSearchInput.addEventListener('input', (e) => {
        const query = e.target.value;
        // Si hay texto, filtra. Si estÃ¡ vacÃÂ­o, muestra todos.
        const matches = query ? filterArtists(query) : artistList;
        renderArtistSuggestions(matches);
    });

    // Mostrar todos al hacer click (focus)
    artistSearchInput.addEventListener('click', () => {
        artistSearchInput.classList.remove('centered-text'); // Align left for editing
        const query = artistSearchInput.value;
        const matches = query ? filterArtists(query) : artistList;
        renderArtistSuggestions(matches);
    });

    artistSearchInput.addEventListener('focus', () => {
        artistSearchInput.classList.remove('centered-text');
    });

    artistSearchInput.addEventListener('blur', () => {
        if (selectedArtist && artistSearchInput.value === selectedArtist) {
            artistSearchInput.classList.add('centered-text');
        }
    });


    document.addEventListener('click', (e) => {
        if (!artistSearchInput.contains(e.target) && !artistListEl.contains(e.target)) {
            artistListEl.classList.remove('show');
        }
    });

    async function resetGame(forceNew = false) {
        // STOP CONFETTI: Immediately clear when starting new round
        if (typeof confetti !== 'undefined' && confetti.reset) {
            confetti.reset();
        }

        // CRITICAL: Reset game over and full song playback state
        audioPlayer.pause();
        // Force clear immediately to prevent old song from playing during async fetch
        audioPlayer.src = "";

        isGameOver = false;
        isFullSongPlaying = false;
        snippetState = 'idle';

        // Clear full player interval if running
        if (fullPlayerInterval) {
            clearInterval(fullPlayerInterval);
            fullPlayerInterval = null;
        }

        if (fullSongTime) fullSongTime.textContent = '0:00 / 0:00';
        audioPlayer.onloadedmetadata = null; // limpiar listeners
        audioPlayer.onended = null;
        if (fullSongIconPlay) updateFullPlayerIcon(false);

        isSnippetPlaying = false;
        snippetRemainingMs = 0;
        snippetDurationMs = 0;

        // Si se fuerza un juego nuevo (botÃÂ³n reset/play again), borramos la canciÃÂ³n guardada
        if (forceNew) {
            playSound('click');
            localStorage.removeItem('savedSong');
        }

        // availableSongs se rellena dentro de selectRandomSong si estÃ¡ vacÃÂ­o
        selectRandomSong();

        guessCount = 0;
        hasGuessedCorrectly = false;
        searchInput.value = "";
        songsList.classList.remove('show');
        songsList.classList.remove('show');
        gameOverMessage.classList.remove('show');

        // Hide share container
        const shareCont = document.getElementById('share-container');
        if (shareCont) shareCont.style.display = 'none';
        const mobBtn = document.getElementById('mobile-share-btn');
        if (mobBtn) mobBtn.style.display = 'none';

        // DELAYED: Clean up colors (so they don't flash during fade out)
        setTimeout(() => {
            gameOverContent.classList.remove('win', 'lose');
        }, 300);

        // Si no hay canciÃÂ³n seleccionada (modo artista sin artista), deshabilitar bÃÂºsqueda
        if (!currentSong.archivo) {
            document.getElementById('search-container').classList.add('disabled');
        } else {
            document.getElementById('search-container').classList.remove('disabled');
        }

        playButton.setAttribute('disabled', '');
        // Disable skip while loading
        skipButton.disabled = true;
        // Show loader
        playButton.innerHTML = '<div class="loader"></div>';

        clearGuessBoxes();


        gameStartTime = 0;

        updateTimeMarker(0);
        if (progressBarFill) progressBarFill.style.width = '0%';
        // updatePlayIcon(false); // REMOVED: This was overwriting the loader immediately!


        if (currentBlobUrl) {
            URL.revokeObjectURL(currentBlobUrl);
            currentBlobUrl = null;
        }

        if (currentSong.archivo) {
            // FIX: Encode URL to handle spaces and special chars on GitHub Pages
            const encodedPath = encodeURI(currentSong.archivo);

            if (window.location.protocol !== 'file:') {
                try {
                    const response = await fetch(encodedPath);
                    const blob = await response.blob();
                    currentBlobUrl = URL.createObjectURL(blob);
                    audioPlayer.src = currentBlobUrl;
                } catch (e) {
                    console.error("Error loading audio blob:", e);
                    audioPlayer.src = encodedPath; // Fallback
                }
            } else {
                // Local file: use direct path
                audioPlayer.src = currentSong.archivo;
            }
        } else {
            audioPlayer.src = "";
        }

        audioPlayer.currentTime = gameStartTime;

        // Configurar listener para calcular inicio aleatorio cuando tengamos la duraciÃÂ³n
        audioPlayer.onloadedmetadata = () => {
            const duration = audioPlayer.duration;
            if (isFinite(duration) && duration > 15) {
                // Random start time: from 0 to duration - 15
                gameStartTime = Math.random() * (duration - 15);
            } else {
                gameStartTime = 0;
            }
            // console.log("Random start time:", gameStartTime, "Duration:", duration);

            audioPlayer.currentTime = gameStartTime;

            saveModeState(currentMode);

            // Limpiar listener para evitar ejecuciones mÃÂºltiples
            audioPlayer.onloadedmetadata = null;
        };

        audioPlayer.load(); // forzar la carga de la nueva fuente

        // correcciÃÂ³n: usar oncanplaythrough para activar el botÃÂ³n solo cuando el audio estÃ¡ listo
        audioPlayer.oncanplaythrough = () => {
            // re-establecer currentTime con el valor aleatorio calculado
            audioPlayer.currentTime = gameStartTime;
            playButton.removeAttribute('disabled');
            // Enable skip
            skipButton.disabled = false;
            // Restore play icon
            updatePlayIcon(false);

            audioPlayer.oncanplaythrough = null; // limpiar el listener
        };

        // Actualizar display de racha al reset
        updateStreakDisplay();
        updateStreakSaverUI();

        // PERSISTENCIA: Guardar estado inmediatamente al iniciar nuevo juego
        saveModeState(currentMode);
    }

    // Nueva funciÃÂ³n para reseteo completo (botÃÂ³n REINICIAR)
    function fullReset() {
        if (currentMode === 'normal') {
            winStreak = 0;
            streaksavers = 0;
            localStorage.setItem('winStreak', winStreak);
            localStorage.setItem('streaksavers', streaksavers);
        } else {
            artistStreak = 0;
            localStorage.setItem('artistStreak', artistStreak);
        }

        // Limpiar estado guardado del juego
        localStorage.removeItem('underless_save_v1');
        normalModeState = null;
        artistModeState = null;
        albumModeState = null;

        // Llamar al reset normal del juego
        resetGame(true);
    }

    function cheatStreak() {
        winStreak = 37;
        localStorage.setItem('winStreak', winStreak);
        updateStreakDisplay();
        updateStreakSaverUI();
    }

    function selectRandomSong() {
        // 1. Determinar qué historial usar y referencia a la variable global correspondiente
        let persistentHistory = currentMode === 'normal' ? playedSongsNormal : playedSongsArtist;
        const persistentHistoryKey = currentMode === 'normal' ? 'playedSongsNormal' : 'playedSongsArtist';

        // 2. Si availableSongs está vacío, llenarlo
        if (!availableSongs || availableSongs.length === 0) {
            let fullPool = [];
            if (currentMode === 'artist') {
                if (selectedArtist) {
                    // MODO ARTISTA: Comportamiento de "Lista/Playlist" -> Cargar TODAS las canciones
                    // No filtramos por historial aquÃÂ­ para permitir que las canciones vuelvan a sonar en la siguiente vuelta
                    fullPool = bibliotecaArtist.filter(song => extractArtist(song.nombre) === selectedArtist);
                    availableSongs = [...fullPool];
                } else {
                    availableSongs = [];
                }
            } else if (currentMode === 'album') {
                if (selectedAlbum) {
                    // MODO ÃÂLBUM: Comportamiento de "Lista/Playlist" -> Cargar TODAS las canciones del Ã¡lbum
                    const albumInfo = albumsData.find(a => a.name === selectedAlbum);
                    if (albumInfo && albumInfo.songs) {
                        availableSongs = [...albumInfo.songs];
                    } else {
                        availableSongs = [];
                    }
                } else {
                    availableSongs = [];
                }
            } else {
                // MODO NORMAL: Comportamiento original
                fullPool = [...biblioteca];
                // Filtrar las que ya estÃ¡n en el historial para dar variedad
                availableSongs = fullPool.filter(song => !persistentHistory.includes(song.nombre));

                // Si se agotan (ya se jugaron todas las posibles menos las del historial), reiniciamos
                if (availableSongs.length === 0 && fullPool.length > 0) {
                    persistentHistory = []; // Reiniciar historial local
                    // Actualizar variable global y storage
                    playedSongsNormal = [];
                    localStorage.setItem('playedSongsNormal', JSON.stringify([]));

                    availableSongs = [...fullPool];
                }
            }
        }

        // Si no hay canciones disponibles (ej. modo artista sin artista seleccionado), salir
        if (availableSongs.length === 0) {
            currentSong = {};
            return;
        }

        // 3. Elegir canciÃÂ³n aleatoria
        let randomIndexInAvailable = Math.floor(Math.random() * availableSongs.length);
        let selectedSongCandidate = availableSongs[randomIndexInAvailable];

        // 4. MODO ARTISTA/ÃÂLBUM: Evitar repetición en lapso corto (Constraint check)
        // Aunque availableSongs garantiza no repetición DENTRO de la ronda, 
        // al resetear la lista (nueva ronda) podría tocar una que recién sonó.
        if (currentMode === 'artist' || currentMode === 'album') {
            const SHORT_LAPSE = 12; // Cantidad de canciones recientes a evitar
            const recentSongs = persistentHistory.slice(-SHORT_LAPSE);

            // Solo intentamos buscar otra si hay suficientes opciones
            if (availableSongs.length > 1) {
                let attempts = 0;
                // Mientras la candidata esté en las recientes, buscamos otra
                while (recentSongs.includes(selectedSongCandidate.nombre) && attempts < 20) {
                    randomIndexInAvailable = Math.floor(Math.random() * availableSongs.length);
                    selectedSongCandidate = availableSongs[randomIndexInAvailable];
                    attempts++;
                }
            }
        }

        // 5. Asignar canciÃÂ³n final
        currentSong = selectedSongCandidate;

        // 6. Sacarla de availableSongs (para esta sesiÃÂ³n/ronda)
        availableSongs.splice(randomIndexInAvailable, 1);

        // 7. Actualizar historial persistente
        persistentHistory.push(currentSong.nombre);

        // Limitar historial (mantener solo las ÃÂºltimas 20 para referencia)
        if (persistentHistory.length > 20) {
            persistentHistory.shift();
        }

        // Guardar cambios en las variables globales y localStorage
        if (currentMode === 'normal') {
            playedSongsNormal = persistentHistory;
            localStorage.setItem('playedSongsNormal', JSON.stringify(playedSongsNormal));
        } else {
            playedSongsArtist = persistentHistory;
            localStorage.setItem('playedSongsArtist', JSON.stringify(playedSongsArtist));
        }
    }

    function clearGuessBoxes() {
        const boxes = document.querySelectorAll('.guess-box');
        boxes.forEach(box => {
            box.textContent = "";
            box.classList.remove('correct');
            box.classList.remove('incorrect');
            box.classList.remove('skipped');
            box.classList.remove('partial');
            // Limpiar también la clase partial (amarillo)
        });
    }

    // NUEVO: Helpers para persistencia visual
    function getGuessStates() {
        const boxes = document.querySelectorAll('.guess-box');
        return Array.from(boxes).map(box => ({
            text: box.textContent,
            classes: [...box.classList].filter(c => c !== 'guess-box')
        }));
    }

    function restoreGuessStates(guesses) {
        const boxes = document.querySelectorAll('.guess-box');
        guesses.forEach((guess, i) => {
            if (boxes[i]) {
                boxes[i].textContent = guess.text;
                guess.classes.forEach(c => boxes[i].classList.add(c));
            }
        });
    }

    // =====================================================
    // AUDIO PLAYER - Core Functions (Mobile-Optimized v2.0)
    // =====================================================

    function pauseAudioInternal(resetToIdle = true) {
        // 1. Pause the audio
        audioPlayer.pause();

        // 2. Stop animation loop
        stopAnimationLoop();

        // 3. Update state
        snippetState = resetToIdle ? 'idle' : 'paused';

        // 4. Update UI
        updatePlayIcon(false);
    }

    // nuevas funciones para reproductor completo
    function updateFullPlayerIcon(playing) {
        if (playing) {
            fullSongIconPlay.style.display = 'none';
            fullSongIconPause.style.display = 'inline-block';
        } else {
            fullSongIconPlay.style.display = 'inline-block';
            fullSongIconPause.style.display = 'none';
        }
    }

    // intervalo para actualizar el tiempo y la barra
    function startFullPlayerUpdate() {
        if (fullPlayerInterval) clearInterval(fullPlayerInterval);

        fullPlayerInterval = setInterval(() => {
            const currentTime = audioPlayer.currentTime;
            const duration = audioPlayer.duration;

            if (audioPlayer.paused || audioPlayer.ended) {
                if (audioPlayer.ended) {
                    isFullSongPlaying = false;
                    updateFullPlayerIcon(false);
                    audioPlayer.currentTime = 0;
                    if (fullSongSeeker) fullSongSeeker.value = 0;
                }
                clearInterval(fullPlayerInterval);
                fullPlayerInterval = null;
                return;
            }

            if (isFinite(duration) && duration > 0 && fullSongSeeker && fullSongTime) {
                const percentage = (currentTime / duration) * 100;
                fullSongSeeker.value = percentage;
                fullSongTime.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
            }
        }, 500); // actualizar dos veces por segundo
    }

    // listener para el slider de bÃÂºsqueda (seeker)
    function setupFullSongSeeker() {
        if (!fullSongSeeker || fullSongSeeker.dataset.listenerSet) return;

        // al mover el slider (input), solo actualiza el tiempo en pantalla
        fullSongSeeker.addEventListener('input', function () {
            const duration = audioPlayer.duration || 0;
            const seekTo = duration * (this.value / 100);
            fullSongTime.textContent = `${formatTime(seekTo)} / ${formatTime(duration)}`;
        });

        // al soltar el slider (change), busca la posiciÃÂ³n y reproduce si estaba pausado
        fullSongSeeker.addEventListener('change', function () {
            const duration = audioPlayer.duration || 0;
            const seekTo = duration * (this.value / 100);

            if (audioPlayer.readyState >= 2) {
                audioPlayer.currentTime = seekTo;
                // si no estaba reproduciendo, iniciar la reproducción y el tracking
                if (!isFullSongPlaying && audioPlayer.paused) {
                    audioPlayer.play().catch(e => console.warn('fallo al reproducir después de buscar:', e));
                    isFullSongPlaying = true;
                    updateFullPlayerIcon(true);
                    startFullPlayerUpdate();
                }
            }
        });

        fullSongSeeker.dataset.listenerSet = true;
    }

    // inicializaciÃÂ³n del reproductor completo cuando el modal se abre
    function initializeFullPlayer() {
        // CONTINUOUS PLAYBACK: If game over, don't stop audio, just sync UI
        if (isGameOver) {
            // Auto-resume if paused
            if (audioPlayer.paused) {
                audioPlayer.play().catch(e => console.warn('Auto-resume failed:', e));
            }

            isFullSongPlaying = true;
            updateFullPlayerIcon(true);
            startFullPlayerUpdate();
            setupFullSongSeeker();

            // Ensure onended is set to handle when song finishes naturally
            audioPlayer.onended = () => {
                isFullSongPlaying = false;
                updateFullPlayerIcon(false);
                audioPlayer.currentTime = 0;
                if (fullSongSeeker) fullSongSeeker.value = 0;
                if (fullSongTime) fullSongTime.textContent = `0:00 / ${formatTime(audioPlayer.duration)}`;
                if (fullPlayerInterval) clearInterval(fullPlayerInterval);
                fullPlayerInterval = null;
            };
            return;
        }

        // detener reproductor de snippet si aÃÂºn estaba activo
        pauseAudioInternal();

        // resetear el estado del reproductor completo
        isFullSongPlaying = false;
        updateFullPlayerIcon(false);
        if (fullPlayerInterval) clearInterval(fullPlayerInterval);
        fullPlayerInterval = null;


        if (currentBlobUrl) {
            audioPlayer.src = currentBlobUrl;
        } else {
            if (window.location.protocol !== 'file:') {
                audioPlayer.src = currentSong.archivo;
            } else {
                audioPlayer.src = currentSong.archivo;
            }
        }
        audioPlayer.currentTime = 0;
        audioPlayer.load(); // forzar la carga de metadatos (duraciÃÂ³n)

        // configurar el seeker
        setupFullSongSeeker();
        if (fullSongSeeker) fullSongSeeker.value = 0;

        // esperar a que se carguen los metadatos para obtener la duraciÃÂ³n
        audioPlayer.onloadedmetadata = () => {
            const duration = audioPlayer.duration;
            if (fullSongTime) fullSongTime.textContent = `0:00 / ${formatTime(duration)}`;
            audioPlayer.onloadedmetadata = null; // limpiar para evitar mÃÂºltiples llamadas
        };

        // configurar el evento de finalizaciÃÂ³n
        audioPlayer.onended = () => {
            isFullSongPlaying = false;
            updateFullPlayerIcon(false);
            audioPlayer.currentTime = 0;
            if (fullSongSeeker) fullSongSeeker.value = 0;
            if (fullSongTime) fullSongTime.textContent = `0:00 / ${formatTime(audioPlayer.duration)}`;
            if (fullPlayerInterval) clearInterval(fullPlayerInterval);
            fullPlayerInterval = null;
        };
    }

    function toggleFullSong() {
        if (!currentSong.archivo) return;

        if (isFullSongPlaying) {
            audioPlayer.pause();
            isFullSongPlaying = false;
            updateFullPlayerIcon(false);
            if (fullPlayerInterval) clearInterval(fullPlayerInterval);
            fullPlayerInterval = null;
        } else {
            pauseAudioInternal(); // detener el snippet si estaba sonando

            // si estÃ¡ pausada y no en el inicio, reanudar
            if (audioPlayer.paused && audioPlayer.currentTime > 0) {
                audioPlayer.play().catch(e => console.warn('fallo al reanudar canción completa:', e));
            } else {
                // si estÃ¡ en el inicio (0:00) o terminÃÂ³, empezar desde el principio (ya cargado por initializeFullPlayer)
                audioPlayer.currentTime = 0;
                audioPlayer.play().catch(e => console.warn('fallo al reproducir canción completa:', e));
            }

            isFullSongPlaying = true;
            updateFullPlayerIcon(true);
            startFullPlayerUpdate();
        }
    }

    /**
     * Updates the play button icon
     */
    function updatePlayIcon(playing) {
        playButton.innerHTML = playing ? iconPause : iconPlay;
        playButton.setAttribute('aria-label', playing ? 'pausar fragmento' : 'escuchar fragmento');
    }

    /**
     * Finishes snippet playback - called when target time is reached
     */
    function finishSnippet() {
        pauseAudioInternal(true);
        // Don't reset currentTime - keep position for potential resume after skip
    }


    function animationLoop() {
        // Stop if not playing
        if (snippetState !== 'playing') {
            animationFrameId = null;
            return;
        }

        const currentTime = audioPlayer.currentTime;

        // CONTINUOUS PLAYBACK: Stop checking limits if game is over
        if (isGameOver) {
            animationFrameId = null;
            return;
        }

        // Check if we've reached or passed the target time
        // FIX: If user guessed correctly, DON'T stop playback. Let it play through the cooldown.
        if (currentTime >= snippetTargetTime && !hasGuessedCorrectly) {
            // Use VISUAL duration (0.1s) not actual playback duration (0.2s) for progress bar
            const durations = getDurations();
            const visualDuration = durations[guessCount] || getTotalGameDuration();
            const targetPercentage = getPercentage(visualDuration);

            progressBarFill.style.width = targetPercentage + '%';

            // Stop playback
            finishSnippet();
            return;
        }

        // Update progress bar
        const elapsedFromStart = Math.max(0, currentTime - gameStartTime);

        // Use VISUAL duration for progress bar, not actual playback duration
        // This prevents the bar from overshooting the visual 0.1s divider when playing 0.2s
        const durations = getDurations();
        const visualDuration = durations[guessCount] || getTotalGameDuration();
        const actualDuration = snippetTargetTime - gameStartTime;

        // Scale elapsed time to visual duration
        // If we're playing 0.2s but showing 0.1s, scale proportionally
        const scaleFactor = visualDuration / actualDuration;
        const visualElapsed = Math.min(elapsedFromStart * scaleFactor, visualDuration);

        const percentage = getPercentage(visualElapsed);
        progressBarFill.style.width = percentage + '%';

        // Continue the loop
        animationFrameId = requestAnimationFrame(animationLoop);
    }

    /**
     * Starts the animation loop for smooth progress updates
     */
    function startAnimationLoop() {
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
        }
        animationFrameId = requestAnimationFrame(animationLoop);
    }

    /**
     * Stops the animation loop
     */
    function stopAnimationLoop() {
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
    }

    /**
     * Main playback function - Mobile-Optimized v2.0
     * Uses audio events instead of timers for reliable mobile playback
     */
    function playSnippet() {
        // Prevent playing if in album mode without album selection
        if (currentMode === 'album' && !selectedAlbum) return;

        if (hasGuessedCorrectly || playButton.hasAttribute('disabled')) return;

        const durations = getDurations();
        let targetDuration = durations[guessCount] || getTotalGameDuration();

        // "Mentira" del 0.2s: visual shows 0.1s but plays 0.2s
        if (guessCount === 0 && targetDuration === 0.1) {
            targetDuration = 0.2;
        }

        // Toggle pause if already playing
        if (snippetState === 'playing') {
            pauseAudioInternal(false); // pause, don't reset to idle
            return;
        }

        // Calculate the absolute target time in the audio
        snippetTargetTime = gameStartTime + targetDuration;

        // Determine if we should restart or resume
        const currentTime = audioPlayer.currentTime;
        const tolerance = 0.05; // 50ms tolerance

        const isShortDuration = targetDuration <= 0.5;
        const isPastTarget = currentTime >= snippetTargetTime - tolerance;
        const isBeforeStart = currentTime < gameStartTime - tolerance;

        if (isShortDuration || isPastTarget || isBeforeStart) {
            audioPlayer.currentTime = gameStartTime;
        }

        // Start playback
        audioPlayer.play()
            .then(() => {
                snippetState = 'playing';
                updatePlayIcon(true);

                // Start the smooth animation loop
                startAnimationLoop();
            })
            .catch(e => {
                console.warn('Error starting playback:', e);
                snippetState = 'idle';
                updatePlayIcon(false);
            });
    }



    // función de game over modificada

    // SMART RANDOM LOGIC
    const messageHistory = { win: [], lose: [] };

    function getNonRepeatingMessage(messages, type) {
        const history = messageHistory[type];
        // Filter out messages currently in history (last 3 shown)
        let available = messages.filter(msg => !history.includes(msg));

        // Fallback: If all messages are in history (shouldn't happen with large pools, but for safety)
        // or if available is too small, just pick from full pool avoiding the VERY last one if possible.
        if (available.length === 0) {
            const lastOne = history[history.length - 1];
            available = messages.filter(msg => msg !== lastOne);
        }

        // Final fallback if still empty (e.g. pool size 1)
        if (available.length === 0) available = messages;

        const randomMsg = available[Math.floor(Math.random() * available.length)];

        // Update history
        history.push(randomMsg);
        if (history.length > 3) history.shift(); // Keep last 3

        return randomMsg;
    }
    function showGameOver(won, isDuplicate = false) {
        isGameOver = true;

        // inicializar el reproductor completo antes de mostrar el modal
        initializeFullPlayer();

        if (won) {
            const winMessages = ["GANASTE GG", "SOS BUENO", "CHAD HUMANO", "QUE PIBE TAN UNDER", "ZARPADO EN CHETO", "boeee...", "estoy orgulloso hijo", "CLAP CLAP", "ESTE SI QUE SABE", "watejel"];
            // const randomMsg = winMessages[Math.floor(Math.random() * winMessages.length)];
            const randomMsg = getNonRepeatingMessage(winMessages, 'win');
            gameResult.textContent = randomMsg;
            gameOverContent.classList.remove('win', 'lose'); // limpia ambas
            gameOverContent.classList.add('win');
            answerLabel.textContent = "la cancion era"; // etiqueta simple

            if (currentMode === 'normal') {
                winStreak++;
                localStorage.setItem('winStreak', winStreak);
                // Recompensas de Streak Save (solo en normal)
                if (winStreak === 10 || winStreak === 20 || winStreak === 40 || winStreak === 100) {
                    streaksavers++;
                    localStorage.setItem('streaksavers', streaksavers);
                }
            } else {
                // ARTIST / ALBUM MODE
                if (!isDuplicate) {
                    artistStreak++;
                    localStorage.setItem('artistStreak', artistStreak);
                }
            }

            updateStreakDisplay();
            updateStreakSaverUI();

            // Confeti sutil y breve
            confetti({
                particleCount: 70,
                spread: 70,
                origin: { y: 0.6 },
                ticks: 200, // DuraciÃÂ³n breve
                gravity: 1.2,
                scalar: 0.9
            });

        } else {
            playSound('gameover');

            // Mensajes aleatorios de derrota
            const loseMessages = ["PERDISTE", "MAL AHI", "NECESITÁS MEJORAR", "DEDICATE AL PADEL", "NAAH :(", "SAJ", "FAKE FAN", "PETÓN HISTORICO", "TE TENIA FE", "mal aji broder", "eeee?", "xdd"];
            // const randomMsg = loseMessages[Math.floor(Math.random() * loseMessages.length)];
            const randomMsg = getNonRepeatingMessage(loseMessages, 'lose');
            gameResult.textContent = randomMsg;

            gameOverContent.classList.remove('win', 'lose'); // Ã¡limpia ambas!
            gameOverContent.classList.add('lose');
            answerLabel.textContent = "la cancion era"; // etiqueta simple

            // LÃÂ³gica de salva rachas al perder
            if (currentMode === 'normal') {
                // Ocultar UI de share por defecto al perder (se muestra solo si es fatal)
                const shareCont = document.getElementById('share-container');
                if (shareCont) shareCont.style.display = 'none';
                const mobBtn = document.getElementById('mobile-share-btn');
                if (mobBtn) mobBtn.style.display = 'none';

                if (winStreak >= minstreak && streaksavers > 0) {
                    streaksavers--;
                    localStorage.setItem('streaksavers', streaksavers);
                    // Vida consumida, racha salvada.
                } else {
                    // Si no hay vidas o no llegamos al minstreak, reset fatal.

                    // === SHARE CARD TRIGGER (FATAL LOSS ONLY) ===
                    // Capturamos el streak antes de resetearlo
                    if (winStreak > 15) {
                        try {
                            generateShareCard(currentSong.nombre, winStreak);
                            // Mostrar UI segÃÂºn dispositivo
                            if (window.innerWidth > 768) {
                                if (shareCont) shareCont.style.display = 'flex';
                            } else {
                                if (mobBtn) mobBtn.style.display = 'block';
                            }
                        } catch (err) {
                            console.error("Error generating share card:", err);
                        }
                    }

                    winStreak = 0;
                    localStorage.setItem('winStreak', winStreak);
                }
            } else {
                // Artist o Album mode: reset artistStreak
                artistStreak = 0;
                localStorage.setItem('artistStreak', artistStreak);

                // RESET UNIQUE SONGS TRACKING
                wonSongsInStreak.clear();
                saveModeState(currentMode); // Save cleared state
            }

            updateStreakDisplay();
            updateStreakSaverUI();
        }

        correctAnswerEl.textContent = (currentSong.nombre || "");
        gameOverMessage.classList.add('show');

        // Randomizar texto del botÃÂ³n "una ma"
        const playAgainBtn = document.querySelector('.play-again-button');
        if (playAgainBtn) {
            const btnMessages = ["una ma", "otra?", "la seguimos?", "siguiente", "continuar"];
            playAgainBtn.textContent = btnMessages[Math.floor(Math.random() * btnMessages.length)];
        }

        document.getElementById('search-container').classList.add('disabled');
        playButton.setAttribute('disabled', '');
        skipButton.disabled = true;
    }

    function handleGuessFromSelection(selectedSongName) {
        playSound('click');
        const durations = getDurations();
        if (hasGuessedCorrectly || guessCount >= durations.length) return;

        const correctAnswer = (currentSong.nombre || "").trim();
        const guessBox = document.querySelectorAll('.guess-box')[guessCount];
        songsList.classList.remove('show');

        guessBox.classList.remove('incorrect', 'skipped');

        const isCorrect = selectedSongName.toLowerCase() === correctAnswer.toLowerCase();

        if (isCorrect) {
            guessBox.textContent = currentSong.nombre;
            guessBox.classList.add('correct');
            hasGuessedCorrectly = true;

            // CHECK DUPLICATE WIN (Artist/Album Modes)
            const songName = currentSong.nombre;
            let isDuplicate = false;

            if (currentMode === 'artist' || currentMode === 'album') {
                if (wonSongsInStreak.has(songName)) {
                    isDuplicate = true;
                    showStreakWarning();
                    // NO STREAK INCREMENT
                } else {
                    wonSongsInStreak.add(songName);
                }
                saveModeState(currentMode); // Persist updated set
            }

            // CAMBIO: Deshabilitar inmediatamente y aÃÂ±adir el retraso de 1.5s
            document.getElementById('search-container').classList.add('disabled');
            playButton.setAttribute('disabled', '');
            skipButton.disabled = true;

            setTimeout(() => {
                showGameOver(true, isDuplicate); // Pass isDuplicate flag
            }, 1500); // Retraso de 1.5 segundos

        } else {
            // si falla, se pone el nombre seleccionado en la casilla
            guessBox.textContent = selectedSongName || "intento fallido";

            // LÃÂ³gica de coincidencia parcial (solo modo normal)
            let isPartial = false;
            if (currentMode === 'normal') {
                // Obtener string completo de artistas (antes del guion)
                const guessedArtistStr = extractArtistForGuess(selectedSongName);
                const correctArtistStr = extractArtistForGuess(correctAnswer);

                if (guessedArtistStr && correctArtistStr) {
                    // Separar por comas y limpiar espacios
                    const guessedArtists = guessedArtistStr.split(',').map(a => a.trim().toLowerCase());
                    const correctArtists = correctArtistStr.split(',').map(a => a.trim().toLowerCase());

                    // Verificar si hay ALGUNA coincidencia
                    // Si algÃÂºn artista de la canciÃÂ³n adivinada estÃ¡ en la lista de artistas de la correcta
                    const match = guessedArtists.some(g => correctArtists.includes(g));
                    if (match) {
                        isPartial = true;
                    }
                }
            }

            if (isPartial) {
                guessBox.classList.add('partial'); // Amarillo
            } else {
                guessBox.classList.add('incorrect'); // Rojo
            }

            guessCount++;
            if (guessCount < durations.length) {
                updateTimeMarker(guessCount);
                finishSnippet();
            } else {
                showGameOver(false);
            }
        }
        document.getElementById('search-input').value = "";
        saveModeState(currentMode); // Guardar estado tras intento
    }


    function handleSkip() {
        const durations = getDurations();
        if (hasGuessedCorrectly || guessCount >= durations.length) return;

        // Si estÃ¡ en modo Mandale, enviar intento
        if (isSubmitMode) {
            // No reproducir sonido aquÃÂ­, ya lo hace handleGuessFromSelection
            const val = searchInput.value.trim();
            if (val) {
                handleGuessFromSelection(val);
                disableSubmitMode(); // Resetear botÃÂ³n tras intento
            }
            return;
        }

        // SONIDO: Solo reproducir click si NO es el ÃÂºltimo skip (para que no se solape con game over)
        if (guessCount < durations.length - 1) {
            playSound('click');
        }

        const guessBox = document.querySelectorAll('.guess-box')[guessCount];

        // >>> INICIO MODIFICACIÃâN JS PARA SKIP <<<
        guessBox.textContent = "Skipped";
        guessBox.classList.remove('incorrect', 'correct'); // asegurar que no tiene rojo ni verde
        guessBox.classList.add('skipped'); // nuevo: usa el gris oscuro
        // >>> FIN MODIFICACIÃâN JS PARA SKIP <<<

        guessCount++;
        if (guessCount < durations.length) {
            updateTimeMarker(guessCount);

            // FIX: Actualizar snippetTargetTime al nuevo lÃÂ­mite del segmento desbloqueado
            // para que el audio no se pause al llegar al lÃÂ­mite del segmento anterior
            let newTargetDuration = durations[guessCount];
            // "Mentira" del 0.2s: visual shows 0.1s but plays 0.2s
            if (guessCount === 0 && newTargetDuration === 0.1) {
                newTargetDuration = 0.2;
            }
            snippetTargetTime = gameStartTime + newTargetDuration;
        } else {
            showGameOver(false);
        }
        document.getElementById('search-input').value = "";
        songsList.classList.remove('show');
        saveModeState(currentMode); // Guardar estado tras skip
    }

    // volumen
    if (volumeSlider) {
        // CORREGIDO: parseFloat
        audioPlayer.volume = parseFloat(volumeSlider.value);
        volumeSlider.addEventListener("input", e => {
            const vol = parseFloat(e.target.value);
            audioPlayer.volume = vol;
            localStorage.setItem('volume', vol);
        });
    }

    // fix visual: sincroniza marcador visual estatico (la flecha)
    function updateTimeMarker(index) {
        const durations = getDurations();
        // CORREGIDO: Math.min
        const safeIndex = Math.min(index, durations.length - 1);
        const targetTime = durations[safeIndex];
        const percentage = getPercentage(targetTime);

        // Ajuste visual para que la flecha no parezca adelantada en 0.1s
        // Si es el primer segmento (0.1s), le restamos un pelÃÂ­n
        let visualPercentage = percentage;
        if (safeIndex === 0) visualPercentage -= 0.5; // Ajuste fino

        timerTextEl.style.left = visualPercentage + '%';
        timerTextEl.textContent = formatSeconds(targetTime);

        const prevDuration = safeIndex > 0 ? durations[safeIndex - 1] : 0;

        const startPercentage = getPercentage(prevDuration);
        // Don't update progress bar fill on skip, only the arrow.
        // progressBarFill.style.width = startPercentage + '%';
    }

    // OLD TIMER-BASED FUNCTIONS REMOVED:
    // startTimeMarkerUpdate and stopTimeMarkerUpdate are replaced by
    // handleSnippetTimeUpdate and updateProgressBarVisuals using timeupdate events

    // -----------------------------------------------------
    // buscador y eventos
    // NUEVO: Variable para controlar el modo del botÃÂ³n Skip
    let isSubmitMode = false;

    function enableSubmitMode() {
        isSubmitMode = true;
        skipButton.textContent = "mandale";
        skipButton.classList.add('submit-mode');
    }

    function disableSubmitMode() {
        isSubmitMode = false;
        skipButton.textContent = "Skip";
        skipButton.classList.remove('submit-mode');
    }

    searchInput.addEventListener('input', function () {
        // Si el usuario escribe, desactivar modo Mandale
        disableSubmitMode();

        // no eliminar funcion de tolowercase aqui, es necesaria para la busqueda
        const query = (this.value || '').toLowerCase();
        songsList.innerHTML = '';
        if (query.length < 2) { songsList.classList.remove('show'); return; }

        let pool = currentMode === 'artist' ? bibliotecaArtist : biblioteca;

        if (currentMode === 'artist' && selectedArtist) {
            pool = pool.filter(s => extractArtist(s.nombre) === selectedArtist);
        } else if (currentMode === 'album' && selectedAlbum) {
            // FILTER BY ALBUM
            const albumData = albumsData.find(a => a.name === selectedAlbum);
            if (albumData) {
                pool = albumData.songs;
            }
        }

        // MEJORADO: BÃÂºsqueda por palabras clave independientes (fuzzy-like)
        const queryTerms = query.split(/\s+/); // Separar por espacios
        const filtered = pool.filter(s => {
            const songName = s.nombre.toLowerCase();
            // Verificar si TODAS las palabras de la bÃÂºsqueda estÃ¡n en el nombre
            return queryTerms.every(term => songName.includes(term));
        });
        if (filtered.length > 0) {
            // CORREGIDO: forEach, appendChild, slice
            filtered.forEach(song => {
                const div = document.createElement('div');
                div.classList.add('suggestion-item');
                div.textContent = song.nombre;

                // EVENTO IMPORTANTE: AHORA LLAMA A LA NUEVA FUNCIÃâN DE ADIVINANZA
                div.addEventListener('click', () => {
                    // primero se rellena el input con el valor seleccionado
                    searchInput.value = song.nombre;
                    songsList.classList.remove('show');

                    // CAMBIO: En lugar de adivinar directo, activar modo Mandale
                    enableSubmitMode();
                });
                songsList.appendChild(div);
            });
            songsList.classList.add('show');
        } else songsList.classList.remove('show');
    });

    // NEW: Re-show suggestions when clicking/focusing on search input with existing text
    searchInput.addEventListener('focus', function () {
        const query = (this.value || '').toLowerCase();
        if (query.length >= 2) {
            // Trigger the same logic as input event
            let pool = currentMode === 'artist' ? bibliotecaArtist : biblioteca;

            if (currentMode === 'artist' && selectedArtist) {
                pool = pool.filter(s => extractArtist(s.nombre) === selectedArtist);
            } else if (currentMode === 'album' && selectedAlbum) {
                const albumData = albumsData.find(a => a.name === selectedAlbum);
                if (albumData) pool = albumData.songs;
            }

            const queryTerms = query.split(/\s+/);
            const filtered = pool.filter(s => {
                const songName = s.nombre.toLowerCase();
                return queryTerms.every(term => songName.includes(term));
            });

            songsList.innerHTML = '';
            if (filtered.length > 0) {
                filtered.forEach(song => {
                    const div = document.createElement('div');
                    div.classList.add('suggestion-item');
                    div.textContent = song.nombre;
                    div.addEventListener('click', () => {
                        searchInput.value = song.nombre;
                        songsList.classList.remove('show');
                        enableSubmitMode();
                    });
                    songsList.appendChild(div);
                });
                songsList.classList.add('show');
            }
        }
    });

    document.addEventListener('click', (event) => {
        if (!event.target.closest('.search-container') && !event.target.closest('#songs-list')) {
            songsList.classList.remove('show');
        }
    });

    // CAMBIO IMPORTANTE: ESTE LISTENER FUE MODIFICADO
    searchInput.addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            // no hace nada, bloquea el enter para forzar la selecciÃÂ³n de la lista
        }
    });

    // -----------------------------------------------------
    // init
    window.addEventListener('load', () => {
        renderGuessBoxes(); // Inicializar cajas
        renderProgressSegments();
        updateTimeMarker(0);

        // Restore volume
        const savedVol = localStorage.getItem('volume');
        if (savedVol !== null && volumeSlider) {
            volumeSlider.value = savedVol;
            audioPlayer.volume = parseFloat(savedVol);
        } else if (volumeSlider) {
            audioPlayer.volume = parseFloat(volumeSlider.value);
        }

        // PERSISTENCIA: Cargar estado guardado
        loadFromLocalStorage();
        currentMode = 'normal'; // FORCE NORMAL MODE ON LOAD (User Request)

        // Restaurar UI segÃÂºn el modo cargado
        if (currentMode === 'artist') {
            modeNormalBtn.classList.remove('active');
            modeArtistBtn.classList.add('active');
            artistSection.classList.add('show');
            populateArtists();
            restoreModeState('artist');
        } else if (currentMode === 'album') {
            modeNormalBtn.classList.remove('active');
            modeAlbumBtn.classList.add('active');
            albumSection.classList.add('show');
            populateAlbums();
            restoreModeState('album');
        } else {
            restoreModeState('normal');
        }

        // Cargar racha inicial (si no se cargÃÂ³ ya en restoreModeState -> resetGame)
        winStreak = parseInt(localStorage.getItem('winStreak')) || 0;
        updateStreakDisplay();
        updateStreakSaverUI();

        // Chequear popup de racha
        checkClaimPopup();

        // Hide lives UI if in album mode
        const streakSaverUI = document.getElementById('streak-saver-ui');
        if (currentMode === 'album' && streakSaverUI) {
            streakSaverUI.style.display = 'none';
        }
    });

    // LÃâGICA POPUP RACHA
    function checkClaimPopup() {
        if (!localStorage.getItem('streakClaimed_v1')) {
            const popup = document.getElementById('streak-claim-popup');
            if (popup) popup.style.display = 'block';
        }
    }

    function claimStreak() {
        playSound('click');
        winStreak += 25;
        streaksavers += 2; // Regalar 2 vidas
        localStorage.setItem('winStreak', winStreak);
        localStorage.setItem('streaksavers', streaksavers);
        updateStreakDisplay();
        updateStreakSaverUI();

        // Marcar como reclamado
        localStorage.setItem('streakClaimed_v1', 'true');

        // Ocultar popup
        const popup = document.getElementById('streak-claim-popup');
        if (popup) popup.style.display = 'none';
    }

    function closeClaimPopup() {
        playSound('click');
        localStorage.setItem('streakClaimed_v1', 'true'); // No mostrar de nuevo
        const popup = document.getElementById('streak-claim-popup');
        if (popup) popup.style.display = 'none';
    }

    // LÃâGICA MODAL BUGS
    function openBugsModal() {
        const modal = document.getElementById('bugs-modal');
        if (modal) {
            // Asegurar display flex antes de la animaciÃÂ³n (aunque ya deberÃÂ­a estar por CSS)
            // pero para esta implementaciÃÂ³n basada en CSS opacity, flex estÃ¡ siempre.
            // Solo necesitamos togglear la clase.
            modal.classList.add('show');
        }
    }

    function closeBugsModal() {
        const modal = document.getElementById('bugs-modal');
        if (modal) modal.classList.remove('show');
    }

    // Cerrar modal bugs al hacer click fuera
    window.addEventListener('click', (e) => {
        const modal = document.getElementById('bugs-modal');
        if (e.target === modal) closeBugsModal();
    });

    // LÃâGICA MODAL RECOMENDAR
    function openRecommendModal() {
        playSound('click');
        const modal = document.getElementById('recommend-modal');
        if (modal) modal.classList.add('show');
    }

    function closeRecommendModal() {
        playSound('click');
        const modal = document.getElementById('recommend-modal');
        if (modal) modal.classList.remove('show');
    }

    // Cerrar modal recomendar al hacer click fuera
    window.addEventListener('click', (e) => {
        const modal = document.getElementById('recommend-modal');
        if (e.target === modal) closeRecommendModal();
    });

    // LÃâGICA MODAL INFO VIDAS
    function openLifeModal() {
        playSound('click');
        const modal = document.getElementById('life-info-modal');
        if (modal) {
            modal.style.display = 'flex';
        }
    }

    function closeLifeModal() {
        playSound('click');
        const modal = document.getElementById('life-info-modal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // Cerrar modal al hacer click fuera del contenido
    window.addEventListener('click', (e) => {
        const modal = document.getElementById('life-info-modal');
        if (e.target === modal) {
            closeLifeModal();
        }
    });

    window.addEventListener('beforeunload', () => {
        pauseAudioInternal();
    });


</script>
<script>
    function ajustarEscala() {
        // DISABLE ON MOBILE/TABLET
        if (window.innerWidth < 850) {
            const ui = document.getElementById("ui-root");
            if (ui) {
                ui.style.transform = '';
                ui.style.position = '';
                ui.style.left = '';
                ui.style.top = '';
            }
            return;
        }

        const baseAncho = 900;
        const baseAlto = 950;

        const escala = Math.min(
            window.innerWidth / baseAncho,
            window.innerHeight / baseAlto
        );

        // aplicar solo al contenedor interno
        const ui = document.getElementById("ui-root");
        if (ui) {
            ui.style.transform = `scale(${escala})`;
            // centrarlo
            ui.style.position = "absolute";
            ui.style.left = `50%`;
            ui.style.top = `0`;
            ui.style.transformOrigin = "top center";
            ui.style.transform = `translateX(-50%) scale(${escala})`;
        }
    }



    // === NEW LOGIC: Volume & Mobile Menu ===
    // Volume Control
    const volSlider = document.getElementById('volume-slider');
    if (volSlider) {
        // Init logic: audioPlayer is already global
        volSlider.value = audioPlayer.volume;
        volSlider.addEventListener('input', (e) => {
            audioPlayer.volume = e.target.value;
        });

        // Update slider if volume changes elsewhere (e.g. from existing slider if any)
        audioPlayer.addEventListener('volumechange', () => {
            volSlider.value = audioPlayer.volume;
        });
    }

    // Mobile Menu Toggle
    function toggleMobileMenu() {
        const d = document.getElementById('mobile-menu-dropdown');
        if (d) d.classList.toggle('show');
    }

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
        const menuContainer = document.getElementById('mobile-menu-container');
        if (menuContainer && !menuContainer.contains(e.target)) {
            const d = document.getElementById('mobile-menu-dropdown');
            if (d) d.classList.remove('show');
        }
    });

    // === SHARE CARD LOGIC ===
    let lastGeneratedDataUrl = null;
    let lastShareStreak = 0;

    function generateShareCard(songName, streak) {
        lastShareStreak = streak;
        const canvas = document.getElementById('share-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');

        // Helper private function to save/preview
        const updatePreview = () => {
            try {
                lastGeneratedDataUrl = canvas.toDataURL('image/png');
                const preview = document.getElementById('share-preview');
                if (preview) preview.src = lastGeneratedDataUrl;
            } catch (e) {
                console.error("Error exporting to DataURL (Security/Tainted):", e);
                // Si falla (ej. canvas sucio), nullificamos para que no se intente compartir basura
                lastGeneratedDataUrl = null;
            }
        };

        // 1. Background
        ctx.fillStyle = '#1e1e1e';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 2. Logo/Title
        ctx.font = 'bold 50px "PoppinsFont", sans-serif';
        ctx.fillStyle = '#ffffff';
        ctx.textAlign = 'center';
        ctx.fillText('UnderLess', canvas.width / 2, 60);

        // 4. "Perdiste con:" (Move UP slightly)
        ctx.font = '30px "OtherTextFont", sans-serif';
        ctx.fillStyle = '#888888';
        ctx.fillText('Perdiste con:', canvas.width / 2, 290);

        // 5. Song Name (Move UP)
        ctx.font = 'bold 36px "OtherTextFont", sans-serif';
        ctx.fillStyle = '#ffffff';
        wrapText(ctx, songName, canvas.width / 2, 340, 500, 45);

        // 6. Streak (Move UP significantly for centering)
        ctx.font = 'bold 100px "PoppinsFont", sans-serif';

        // LOGICA DE COLOR IDENTICA A LA DEL JUEGO
        let color = '#55b725'; // Default
        if (streak <= 5) {
            const progress = (streak - 1) / 4;
            color = lerpColor("#55b725", "#7db800", progress);
        } else if (streak <= 10) {
            const progress = (streak - 5) / 5;
            color = lerpColor("#7db800", "#ffd000", progress);
        } else if (streak <= 15) {
            const progress = (streak - 10) / 5;
            color = lerpColor("#ffd000", "#ff8800", progress);
        } else if (streak <= 20) {
            const progress = (streak - 15) / 5;
            color = lerpColor("#ff8800", "#ff3300", progress);
        } else if (streak <= 25) {
            const progress = (streak - 20) / 5;
            color = lerpColor("#ff3300", "#990000", progress);
        } else if (streak <= 30) {
            const progress = (streak - 25) / 5;
            color = lerpColor("#990000", "#b14aed", progress);
        } else if (streak <= 35) {
            const progress = (streak - 30) / 5;
            color = lerpColor("#b14aed", "#8a2be2", progress);
        } else if (streak <= 99) {
            color = '#8a2be2'; // Violeta intenso
        } else {
            color = '#00d4ff'; // Cyan
        }

        ctx.fillStyle = color;
        ctx.fillText(`RACHA: ${streak}`, canvas.width / 2, 480);

        // 7. Footer
        ctx.fillStyle = '#555555';
        ctx.font = '24px sans-serif';
        ctx.fillText('invalame.github.io/UnderLess', canvas.width / 2, 700);

        // 3. Image (Peepo) - skip if local file to avoid tainted canvas
        if (window.location.protocol === 'file:') {
            console.warn("Working locally: Skipping image draw to avoid Tainted Canvas.");
            updatePreview();
            return;
        }

        const sourceImg = document.getElementById('emote-7tv');
        if (sourceImg && sourceImg.src) {
            const img = new Image();
            img.crossOrigin = "Anonymous"; // CRITICAL FOR CANVAS EXPORT
            img.onload = () => {
                const imgW = 200;
                const imgH = imgW * (img.naturalHeight / img.naturalWidth) || 200;
                ctx.drawImage(img, (canvas.width - imgW) / 2, 80, imgW, imgH);
                updatePreview(); // Update preview ONLY after image is drawn
            };
            img.onerror = () => {
                console.warn("Failed to load share image (CORS/Network). Generating text-only card.");
                updatePreview(); // Update even if image fails
            };
            img.src = sourceImg.src;
        } else {
            // No image source, just update
            updatePreview();
        }
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
        const words = text.split(' ');
        let line = '';
        for (let n = 0; n < words.length; n++) {
            const testLine = line + words[n] + ' ';
            const metrics = ctx.measureText(testLine);
            const testWidth = metrics.width;
            if (testWidth > maxWidth && n > 0) {
                ctx.fillText(line, x, y);
                line = words[n] + ' ';
                y += lineHeight;
            } else {
                line = testLine;
            }
        }
        ctx.fillText(line, x, y);
    }

    // Button Listeners
    const btnDown = document.getElementById('btn-download-img');
    if (btnDown) {
        btnDown.onclick = () => {
            if (!lastGeneratedDataUrl) return;
            const a = document.createElement('a');
            a.href = lastGeneratedDataUrl;
            a.download = `UnderLess-Racha-${lastShareStreak}.png`;
            a.click();
        };
    }



    function triggerMobileShare() {
        const shareCont = document.getElementById('share-container');
        if (shareCont) {
            shareCont.style.display = 'flex';
        }
    }

    function closeShareContainer() {
        const shareCont = document.getElementById('share-container');
        if (shareCont) {
            shareCont.style.display = 'none';
        }
    }

    // Custom Smooth Slow Scroll Implementation
    function applySlowScroll(element) {
        if (!element) return;

        let targetScroll = 0;
        let isAnimating = false;
        let animationFrame;

        element.addEventListener('wheel', (e) => {
            e.preventDefault();

            // If not animating, sync target with current position to avoid jumps
            if (!isAnimating) {
                targetScroll = element.scrollTop;
            }

            // Factor 0.4: Slower than default (approx 40% speed)
            const scrollSpeed = 0.4;
            targetScroll += e.deltaY * scrollSpeed;

            // Clamp target
            const maxScroll = element.scrollHeight - element.clientHeight;
            targetScroll = Math.max(0, Math.min(targetScroll, maxScroll));

            if (!isAnimating) {
                isAnimating = true;
                animateScroll();
            }
        }, { passive: false });

        function animateScroll() {
            // Lerp factor 0.08: Very smooth/soft (lower is smoother)
            const smoothFactor = 0.08;

            const currentScroll = element.scrollTop;
            const diff = targetScroll - currentScroll;

            if (Math.abs(diff) < 0.5) {
                element.scrollTop = targetScroll;
                isAnimating = false;
                return;
            }

            // Interpolate
            element.scrollTop = currentScroll + (diff * smoothFactor);
            animationFrame = requestAnimationFrame(animateScroll);
        }
    }

    window.addEventListener('load', () => {
        applySlowScroll(document.getElementById('songs-list'));
        applySlowScroll(document.getElementById('artist-list'));
        applySlowScroll(document.getElementById('album-list'));
    });

    window.addEventListener("resize", ajustarEscala);
    window.addEventListener("load", ajustarEscala);

    // FIX: Force loader on Play Button when switching modes without selection
    // This ensures visual feedback (spinner) persists until the user picks a song
    ['mode-artist', 'mode-album', 'mode-normal'].forEach(modeId => {
        const btn = document.getElementById(modeId);
        if (btn) {
            btn.addEventListener('click', () => {
                setTimeout(() => {
                    const playBtn = document.getElementById('play-button');
                    // Check conditions to force loader
                    const needsLoader = (currentMode === 'artist' && !selectedArtist) ||
                        (currentMode === 'album' && !selectedAlbum);

                    if (needsLoader && playBtn) {
                        playBtn.innerHTML = '<div class="loader"></div>';
                    }
                }, 50); // Small delay to run after main switch logic
            });
        }
    });
</script>

<!-- ========================================
     UNDERLESS SIDEBAR ROOT
     All sidebar elements scoped under this container
     ======================================== -->
<div id="underless-sidebar-root">
    <!-- Menu Buttons (Hamburger + Settings) -->
    <div class="underless-menu-buttons">
        <button class="underless-hamburger" aria-label="Abrir menu de modos" title="Menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <button class="underless-settings-btn" aria-label="Configuracion" title="Configuracion">
            <img src="img/img_effects.png" alt="settings">
        </button>
    </div>

    <!-- Overlay (darkens background when sidebar open) -->
    <div class="underless-overlay" aria-hidden="true"></div>

    <!-- Sidebar Panel - TEXT ONLY mode selection -->
    <nav class="underless-sidebar" aria-label="Menu de modos de juego">
        <div class="underless-mode-option underless-mode-normal active" aria-label="Modo UnderLess Normal">
            UNDERLESS
        </div>
        <div class="underless-mode-option underless-mode-underorhigher" aria-label="Modo Under or Higher">
            UNDER/HIGHER
        </div>

        <!-- Social Buttons -->
        <div class="underless-social-buttons">
            <a href="https://x.com/Invalame" target="_blank"
                class="underless-social-btn underless-twitter-btn">Twitter</a>
            <a href="https://youtube.com/@UnderLesss" target="_blank"
                class="underless-social-btn underless-youtube-btn">YouTube</a>
        </div>
    </nav>

    <!-- Under or Higher Game -->
    <div class="underless-uoh-game">
        <!-- Left side: hamburger button -->
        <div class="uoh-top-left">
            <button class="uoh-back-btn" id="uoh-back-btn" aria-label="Menu" onclick="toggleSidebar()">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>

        <!-- Right side: same buttons as normal mode -->
        <div class="uoh-top-right">
            <button class="recommend-btn" onclick="openRecommendModal()">recomendar</button>
            <button class="bugs-btn" onclick="openBugsModal()">bugs</button>
            <a href="https://www.youtube.com/@UnderLesss" target="_blank" rel="noopener noreferrer" class="youtube-btn"
                aria-label="YouTube">
                <svg viewBox="0 0 24 24" fill="white" width="20" height="20">
                    <path
                        d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z" />
                </svg>
            </a>
        </div>

        <!-- Header -->
        <header class="game-header">
            <h1 class="game-title"><span class="title-under">Under</span><span class="title-higher">/Higher</span></h1>
            <p class="game-question">¿Cuál tiene <span class="highlight">MÁS</span> oyentes mensuales?</p>
        </header>

        <!-- Score -->
        <div class="score-container">
            <div class="score-circle" id="uoh-score-display">0</div>
        </div>



        <!-- Cards -->
        <main class="cards-container" id="uoh-cards-container">
            <!-- Inline Lose Screen (hidden by default, replaces artists) -->
            <div class="uoh-lose-screen" id="uoh-lose-screen">
                <h2 class="uoh-lose-title">PERDISTE</h2>
                <p class="uoh-lose-subtitle">intentalo de nuevo si queres</p>
                <div class="uoh-lose-score">
                    <span class="uoh-lose-score-label">Tu racha:</span>
                    <span class="uoh-lose-score-value" id="uoh-lose-score-value">0</span>
                </div>
                <div class="uoh-lose-buttons">
                    <button class="uoh-lose-btn uoh-play-again-btn" onclick="UnderlessSidebar.playAgain()">Jugar de
                        nuevo</button>
                    <button class="uoh-lose-btn uoh-exit-btn" onclick="UnderlessSidebar.selectMode('normal')">Ir a
                        UNDERLESS</button>
                </div>
            </div>

            <!-- Card Left -->
            <div class="artist-card" id="uoh-card-left">
                <div class="card-image-container">
                    <img class="card-image" id="uoh-img-left" src="" alt="Artista 1">
                    <div class="result-overlay wrong" id="uoh-overlay-left-wrong"></div>
                    <div class="result-overlay correct" id="uoh-overlay-left-correct"></div>
                </div>
                <div class="card-info">
                    <div class="artist-name-section">
                        <p class="artist-name" id="uoh-name-left">"Artista"</p>
                    </div>
                    <div class="listeners-section">
                        <div class="listeners-container" id="uoh-listeners-left">
                            <p class="listeners-count" id="uoh-count-left">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VS Divider -->
            <div class="vs-divider">VS</div>

            <!-- Card Right -->
            <div class="artist-card" id="uoh-card-right">
                <div class="card-image-container">
                    <img class="card-image" id="uoh-img-right" src="" alt="Artista 2">
                    <div class="result-overlay wrong" id="uoh-overlay-right-wrong"></div>
                    <div class="result-overlay correct" id="uoh-overlay-right-correct"></div>
                </div>
                <div class="card-info">
                    <div class="artist-name-section">
                        <p class="artist-name" id="uoh-name-right">"Artista"</p>
                    </div>
                    <div class="listeners-section">
                        <div class="listeners-container" id="uoh-listeners-right">
                            <p class="listeners-count" id="uoh-count-right">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- SETTINGS MODAL - Reuses EXACT existing modal structure -->
<div id="underless-settings-modal"
    style="position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:7000;opacity:0;visibility:hidden;pointer-events:none;transition:opacity 0.3s ease, visibility 0.3s ease;">
    <div class="modal-box"
        style="background-color:#242829;border:1px solid #575757;border-radius:12px;padding:30px 35px;max-width:400px;width:90%;text-align:center;font-family:'PoppinsFont',sans-serif;position:relative;transform:scale(0.9);transition:transform 0.3s cubic-bezier(0.175,0.885,0.32,1.275);">
        <button class="close-x" onclick="UnderlessSidebar.closeSettingsModal()"
            style="position:absolute;top:12px;right:15px;background:none;border:none;color:#b3b3b3;font-size:1.4em;cursor:pointer;line-height:1;padding:0;">x</button>
        <h3 style="margin:0 0 20px 0;color:#ffffff;font-size:1.2em;">Configuracion</h3>
        <div class="underless-settings-content" style="display:flex;flex-direction:column;gap:20px;margin-top:15px;">
            <div class="underless-settings-row" style="display:flex;align-items:center;gap:12px;">
                <img src="img/img_music.png" alt="musica" style="width:24px;height:24px;object-fit:contain;">
                <label for="underless-music-vol"
                    style="color:#b3b3b3;font-size:0.9rem;min-width:60px;text-align:left;">Musica</label>
                <input type="range" id="underless-music-vol" min="0" max="1" step="0.05" value="1"
                    style="flex:1;height:4px;accent-color:#55b725;cursor:pointer;">
            </div>
            <div class="underless-settings-row" style="display:flex;align-items:center;gap:12px;">
                <img src="img/img_effects.png" alt="efectos" style="width:24px;height:24px;object-fit:contain;">
                <label for="underless-sfx-vol"
                    style="color:#b3b3b3;font-size:0.9rem;min-width:60px;text-align:left;">Efectos</label>
                <input type="range" id="underless-sfx-vol" min="0" max="1" step="0.05" value="1"
                    style="flex:1;height:4px;accent-color:#55b725;cursor:pointer;">
            </div>
        </div>
    </div>
</div>

<!-- LOSE MODAL - Reuses EXACT existing modal structure -->
<div id="underless-lose-modal"
    style="position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:7000;opacity:0;visibility:hidden;pointer-events:none;transition:opacity 0.3s ease, visibility 0.3s ease;">
    <div class="modal-box"
        style="background-color:#242829;border:1px solid #b42828;border-radius:12px;padding:30px 35px;max-width:400px;width:90%;text-align:center;font-family:'PoppinsFont',sans-serif;position:relative;transform:scale(0.9);transition:transform 0.3s cubic-bezier(0.175,0.885,0.32,1.275);">
        <button class="close-x" onclick="UnderlessSidebar.hideLoseModal(); UnderlessSidebar.selectMode('normal');"
            style="position:absolute;top:12px;right:15px;background:none;border:none;color:#b3b3b3;font-size:1.4em;cursor:pointer;line-height:1;padding:0;">x</button>
        <h3 style="margin:0 0 20px 0;color:#b42828;font-size:1.2em;">Perdiste!</h3>
        <p style="color:#b3b3b3;font-size:0.9em;margin:0 0 10px 0;">Tu racha final:</p>
        <div class="underless-lose-streak-display"
            style="font-size:3rem;font-weight:700;color:#55b725;margin:15px 0;font-family:'PoppinsFont',sans-serif;">0
        </div>
        <button class="underless-play-again-btn" onclick="UnderlessSidebar.playAgain()"
            style="background:#55b725;border:none;border-radius:4px;color:#ffffff;padding:12px 25px;cursor:pointer;font-family:'PoppinsFont',sans-serif;font-weight:700;font-size:1rem;width:100%;margin-top:15px;">Jugar
            de nuevo</button>
    </div>
</div>

<!-- UnderLess Sidebar Scripts -->
<script src="sample-artists.js"></script>
<script src="underless-sidebar.js"></script>
</body>

</html>